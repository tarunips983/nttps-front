<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TM&CAM - PDF Records</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/en/f/ff/Andhra_Pradesh_Power_Generation_Company_Limited.jpg">
  <style>
    /* -------------------------
       Base / Desktop CSS (unchanged)
       ------------------------- */
    :root{
      --primary:#007bff;
      --accent:#ff9900;
      --dark:#232f3e;
      --muted:#f0f4f8;
    }
    *{box-sizing:border-box}
    body { margin:0; font-family: "Segoe UI", Arial, sans-serif; background:#f4f4f4; color:#222; -webkit-font-smoothing:antialiased; }
    header { background:var(--dark); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.2); position:sticky; top:0; z-index:1000; }
    header h1{margin:0;font-size:22px}
    .nav-right{display:flex;align-items:center;gap:12px}
    .nav-right input{padding:7px 10px;border-radius:4px;border:none;width:180px}
    .nav-right a{color:white;text-decoration:none;font-weight:600}
    .main-tab-btn{background:#4a5c70;color:#fff;border:0;padding:8px 14px;border-radius:6px;font-weight:700;cursor:pointer}
    .main-tab-btn.active{background:var(--primary)}
    main{width:100%;height:calc(100vh - 67px);display:flex}
    .main-view{width:100%;height:100%;display:flex;flex-direction:row;background:white;display:none}
    .main-view.active{display:flex}
    .left-bar{width:220px;background:var(--muted);border-right:1px solid #ccc;overflow-y:auto;padding:15px;flex-shrink:0}
    .left-bar h3{margin:0 0 12px 0;font-size:18px;color:var(--dark);border-bottom:2px solid #ccc;padding-bottom:8px}
    .right-panel{flex:1;overflow:auto;display:flex;flex-direction:column;height:100%}
    #pdf-grid-wrapper{flex:1;overflow-y:auto;height:100%;padding:20px}
    .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px}
    .product{background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.12);display:flex;flex-direction:column;height:100%}
    .product img{width:100%;height:160px;object-fit:contain;border-radius:6px;padding:10px;background:#fff}
    .product-info{flex:1}
    .product-info h3{font-size:1.05rem;margin:0 0 8px 0;color:var(--dark);line-height:1.3}
    .product-info p{margin:6px 0;font-size:0.9rem;color:#333}
    .view-btn{margin-top:auto;padding:8px 12px;border-radius:6px;border:0;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    footer{background:var(--dark);color:#fff;padding:18px;text-align:center}

    /* PDF modal for desktop (center) */
    #productModal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:1200}
    #productModal.active{display:flex}
    #modalContent{background:#fff;border-radius:10px;width:95%;max-width:1000px;height:90vh;padding:12px;display:flex;flex-direction:column;position:relative;box-shadow:0 8px 30px rgba(0,0,0,0.25)}
    #modalHeader{display:flex;align-items:center;gap:12px;padding:6px 8px;border-bottom:1px solid #eee}
    #modalHeader h2{font-size:1.03rem;margin:0;line-height:1.2}
    #modalHeader p{margin:0;color:var(--accent);font-weight:700}
    #modalBody{flex:1;display:flex;align-items:stretch;justify-content:stretch;padding:8px}
    #pdfFrame{width:100%;height:100%;border:0;border-radius:6px;background:#fff}
    /* default small close icon */
    #closeModal{position:absolute;top:10px;right:14px;cursor:pointer;font-size:20px;color:#c0392b;background:#fff;border-radius:6px;padding:6px;border:1px solid #ddd;z-index:1210}

    /* Mobile-specific redesign (ONLY mobile) */
    @media (max-width: 768px) {
      /* stack layout */
      main{flex-direction:column;height:auto}
      header{padding:10px}
      header h1{font-size:16px}
      .nav-right{width:100%;flex-wrap:wrap;padding-top:8px}
      .nav-right input{width:100%}
      .main-tab-btn{flex:1;padding:10px 8px}
      /* show mobile filter button (visible only mobile) */
      #mobileFilterBtn, #mobileDailyFilterBtn{
        display:block;
        width:calc(100% - 30px);
        margin:10px 15px;
        padding:12px;
        border-radius:8px;
        border:0;
        font-weight:700;
        color:#fff;
        box-shadow:0 6px 20px rgba(0,0,0,0.08);
      }
      #mobileFilterBtn{background:var(--primary)}
      #mobileDailyFilterBtn{background:#28a745}

      /* hide the left bar from the normal flow */
      .left-bar{
        position:fixed;
        left:0;
        top:0;
        height:100vh;
        width:280px;            /* slightly wider on mobile */
        z-index:1300;
        transform:translateX(-110%); /* hidden by default off-screen left */
        transition:transform .32s cubic-bezier(.2,.9,.2,1);
        box-shadow: 6px 0 30px rgba(0,0,0,0.18);
        padding:18px;
        border-right: none;
        background:#fff;
      }
      /* when active, slide in */
      .left-bar.active{transform:translateX(0)}
      /* ensure left-bar content scrolls */
      .left-bar::-webkit-overflow-scrolling:touch;

      /* push right-panel to top and 1-col grid */
      .product-grid{grid-template-columns:1fr;gap:16px;padding:8px}
      .product{padding:14px;border-radius:12px}
      .product img{height:120px}
      .product-info h3{font-size:0.95rem}
      .product-info p{font-size:0.84rem}

      /* MOBILE PDF modal ‚Äî redesign (not full screen, but prominent, easy to close) */
      #productModal{background:rgba(0,0,0,0.5);align-items:flex-end;padding:12px} /* appear from bottom */
      #modalContent{
        width:100%;
        max-width:100%;
        height:78vh;          /* large but not full screen */
        border-radius:12px 12px 0 0;
        padding:0;
        overflow:hidden;
        display:flex;
        flex-direction:column;
      }
      /* big header inside modal */
      #modalHeader{
        padding:14px 16px;
        align-items:center;
        justify-content:space-between;
        border-bottom:1px solid #eee;
        background:#fff;
      }
      #modalHeader h2{font-size:1rem;margin:0}
      #modalHeader p{margin:0}
      /* make close button big and obvious */
      #closeModal{
        position:relative;
        top:0;
        right:0;
        transform:none;
        font-size:18px;
        padding:10px 12px;
        margin-left:8px;
        border-radius:10px;
        border:0;
        background:#fff;
        color:#c0392b;
        box-shadow:0 4px 14px rgba(0,0,0,0.12);
      }
      /* toolbar under header with small actions */
      #modalToolbar{display:flex;gap:8px;padding:10px;background:#fafafa;border-bottom:1px solid #f0f0f0}
      #modalToolbar button{padding:8px 12px;border-radius:8px;border:0;background:#e9ecef;font-weight:700}
      /* iframe area */
      #modalBody{padding:0;height:calc(78vh - 92px)} /* header + toolbar ~92 */
      #pdfFrame{height:100%;border-radius:0}
      /* make it easy to swipe close area */
      .drag-handle{height:6px;width:60px;background:#ddd;border-radius:999px;margin:10px auto 0}
    }

    /* small utility */
    .pdf-nav-header{background:var(--accent);padding:10px;border-radius:6px;color:white;font-weight:700;margin-bottom:8px;border:none;display:block;text-align:left}
    .pdf-nav-content button{display:block;width:100%;padding:8px;border-radius:6px;border:0;margin:6px 0;background:#5a6c80;color:#fff}

  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:12px">
      <img src="https://upload.wikimedia.org/wikipedia/en/f/ff/Andhra_Pradesh_Power_Generation_Company_Limited.jpg"
           alt="logo" style="height:42px;border-radius:4px;background:#fff;padding:2px">
      <h1>TM&CAM - PDF Records</h1>
    </div>

    <div class="nav-right">
      <input id="searchInput" placeholder="Search by Work, PR No, or Send To..." />
      <button id="viewTabPdf" class="main-tab-btn" onclick="showMainView('pdf')">üìÑ PDF's Records</button>
      <button id="viewTabProgress" class="main-tab-btn" onclick="showMainView('progress')">üìÖ Daily Progress</button>
      <a href="javascript:void(0)" onclick="openPasswordModal()" title="Add New Record">‚ûï Add Record</a>
      <a href="login.html" id="loginLink" title="Login Page">üîê Login</a>
    </div>
  </header>

  <!-- Mobile toggles (visible on mobile only by CSS) -->
  <button id="mobileFilterBtn" style="display:none;">üìÇ Filters</button>
  <button id="mobileDailyFilterBtn" style="display:none;">üìÇ Daily Filters</button>

  <main>
    <!-- PDF View -->
    <div id="pdf-view-container" class="main-view">
      <aside id="pdf-nav-bar" class="left-bar" aria-hidden="true">
        <h3>Filter Records</h3>
        <button class="pdf-nav-btn show-all active" onclick="showAllPDFs(this)">üìÇ Show All</button>

        <div>
          <button class="pdf-nav-header" onclick="togglePdfNav(this)">Sub Div-I</button>
          <div class="pdf-nav-content">
            <button onclick="filterRecords('Sub Div-I','PR', this)">PRs</button>
            <button onclick="filterRecords('Sub Div-I','Estimate', this)">Estimates</button>
            <button onclick="filterRecords('Sub Div-I','Drawing', this)">Drawings</button>
            <button onclick="filterRecords('Sub Div-I','Other Record', this)">Other Records</button>
          </div>
        </div>

        <div>
          <button class="pdf-nav-header" onclick="togglePdfNav(this)">Sub Div-II</button>
          <div class="pdf-nav-content">
            <button onclick="filterRecords('Sub Div-II','PR', this)">PRs</button>
            <button onclick="filterRecords('Sub Div-II','Estimate', this)">Estimates</button>
            <button onclick="filterRecords('Sub Div-II','Drawing', this)">Drawings</button>
            <button onclick="filterRecords('Sub Div-II','Other Record', this)">Other Records</button>
          </div>
        </div>

        <div>
          <button class="pdf-nav-header" onclick="togglePdfNav(this)">Sub Div-III</button>
          <div class="pdf-nav-content">
            <button onclick="filterRecords('Sub Div-III','PR', this)">PRs</button>
            <button onclick="filterRecords('Sub Div-III','Estimate', this)">Estimates</button>
            <button onclick="filterRecords('Sub Div-III','Drawing', this)">Drawings</button>
            <button onclick="filterRecords('Sub Div-III','Other Record', this)">Other Records</button>
          </div>
        </div>

        <div>
          <button class="pdf-nav-header" onclick="togglePdfNav(this)">Sub Div-IV</button>
          <div class="pdf-nav-content">
            <button onclick="filterRecords('Sub Div-IV','PR', this)">PRs</button>
            <button onclick="filterRecords('Sub Div-IV','Estimate', this)">Estimates</button>
            <button onclick="filterRecords('Sub Div-IV','Drawing', this)">Drawings</button>
            <button onclick="filterRecords('Sub Div-IV','Other Record', this)">Other Records</button>
          </div>
        </div>
      </aside>

      <section id="pdf-grid-wrapper" class="right-panel">
        <div id="loader" style="text-align:center;padding:20px">Loading...</div>
        <div class="product-grid" id="product-list" style="display:none"></div>
      </section>
    </div>

    <!-- Daily Progress view -->
    <div id="daily-progress-container" class="main-view">
      <aside id="inlineLeftBar" class="left-bar" aria-hidden="true">
        <h3>Daily Progress</h3>
        <div id="inlineDateList"><p>Loading dates...</p></div>
      </aside>

      <section id="inlineRightBar" class="right-panel">
        <div class="right-bar-header" style="padding:12px 16px;border-bottom:1px solid #eee;background:#fff">
          <h3 id="inlineSnapshotTitle" style="margin:0">Select a date to view</h3>
          <button id="inlinePrintBtn" onclick="printDailyProgress()" style="display:none">üñ®Ô∏è Print</button>
        </div>
        <div id="inlineSnapshotFrame" style="flex:1;padding:20px">
          <p style="color:#555">Please select a date from the list on the left.</p>
        </div>
      </section>
    </div>
  </main>

  <!-- PDF Modal -->
  <div id="productModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div id="modalContent" role="document">
      <div id="modalHeader">
        <div style="display:flex;align-items:center;gap:12px">
          <h2 id="modalName">Title</h2>
          <p id="modalPR">PR No:</p>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <!-- toolbar (mobile) -->
          <div id="modalToolbar" style="display:none">
            <button id="openInNewBtn" title="Open PDF in new tab">Open</button>
            <button id="downloadBtn" title="Download PDF">Download</button>
          </div>
          <button id="closeModal" aria-label="Close PDF">‚úï</button>
        </div>
      </div>

      <!-- small drag-handle (mobile look) -->
      <div class="drag-handle" style="display:none"></div>

      <div id="modalBody">
        <iframe id="pdfFrame" title="PDF viewer" src="about:blank"></iframe>
      </div>
    </div>
  </div>

  <!-- Password modal (unchanged) -->
  <div id="passwordModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1400">
    <div id="passwordBox" style="background:#fff;padding:20px;border-radius:12px;min-width:280px;max-width:360px">
      <h3 style="margin-top:0">üîê Enter Admin Credentials</h3>
      <input id="usernameInput" placeholder="Username" style="width:100%;padding:8px;margin-bottom:8px">
      <input id="passwordInput" type="password" placeholder="Password" style="width:100%;padding:8px;margin-bottom:10px">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button onclick="verifyPassword()" style="background:var(--primary);color:#fff;padding:8px 12px;border:0;border-radius:6px">Submit</button>
        <button onclick="closePasswordModal()" style="background:#dc3545;color:#fff;padding:8px 12px;border:0;border-radius:6px">Cancel</button>
      </div>
    </div>
  </div>

  <footer>
    <p>üîó Contact | üõ†Ô∏è Help | üîê Privacy</p>
    <p>¬© 2025 MyWeb. Built by Tarun</p>
  </footer>

  <button id="scrollTopBtn" title="Scroll to Top" style="position:fixed;right:18px;bottom:18px;display:none;background:var(--dark);color:#fff;border-radius:50%;border:0;padding:10px;z-index:2000">‚¨ÜÔ∏è</button>

  <script>
    // Server URL unchanged
    const SERVER_URL = "https://nttps-backend.onrender.com";
    let allRecords = [];

    // DOM refs
    const pdfView = document.getElementById("pdf-view-container");
    const progressView = document.getElementById("daily-progress-container");
    const viewTabPdf = document.getElementById("viewTabPdf");
    const viewTabProgress = document.getElementById("viewTabProgress");
    const pdfNav = document.getElementById("pdf-nav-bar");

    const mobileFilterBtn = document.getElementById("mobileFilterBtn");
    const mobileDailyFilterBtn = document.getElementById("mobileDailyFilterBtn");

    // Set initial mobile buttons visibility depending on width
    function updateMobileButtons(){
      if(window.innerWidth <= 768){
        mobileFilterBtn.style.display = "block";
        mobileDailyFilterBtn.style.display = "block";
      } else {
        mobileFilterBtn.style.display = "none";
        mobileDailyFilterBtn.style.display = "none";
        // ensure sidebars visible on desktop
        pdfNav.classList.remove("active");
        document.getElementById("inlineLeftBar")?.classList?.remove("active");
      }
    }
    window.addEventListener("resize", updateMobileButtons);
    updateMobileButtons();

    // Load records
    async function loadRecords(){
      try{
        const res = await fetch(`${SERVER_URL}/records`);
        allRecords = await res.json();
      }catch(e){
        console.error("Failed to load records", e);
        allRecords = []; // fallback
      } finally {
        document.getElementById("loader").style.display = "none";
        document.getElementById("product-list").style.display = "grid";
        renderRecords(allRecords);
        showMainView('pdf');
      }
    }

    // summary helper
    function summarize(text){
      if(!text) return "Untitled Record";
      let clean = text.replace(/Indent for (the )?Procurement of /i, "");
      clean = clean.charAt(0).toUpperCase() + clean.slice(1);
      if(clean.includes("3-Way Temperature Regulators")) return "3-Way Temperature Regulators # DN50 & DN65";
      if(clean.length > 100) clean = clean.substring(0,100) + "...";
      return clean;
    }

    // render records
    function renderRecords(records){
      const container = document.getElementById("product-list");
      if(!records || !records.length){
        container.innerHTML = "<h3 style='text-align:center;color:gray;margin-top:40px;'>No records found.</h3>";
        return;
      }
      container.innerHTML = records.map(r => {
        const recordData = JSON.stringify(r).replace(/'/g, "&apos;");
        return `
          <div class="product" role="article">
            <img src="https://upload.wikimedia.org/wikipedia/en/f/ff/Andhra_Pradesh_Power_Generation_Company_Limited.jpg" alt="APGENCO logo" />
            <div class="product-info">
              <h3>${summarize(r.workName)}</h3>
              <p><strong>PR No:</strong> ${r.prNo || 'N/A'}</p>
              <p><strong>Sub Div:</strong> ${r.subDivision || 'N/A'}</p>
              <p><strong>Type:</strong> ${r.recordType || 'N/A'}</p>
            </div>
            <button class="view-btn" onclick='showPDF(${recordData})'>View PDF</button>
          </div>
        `;
      }).join("");
    }

    // search
    document.getElementById("searchInput").addEventListener("input", e=>{
      showMainView('pdf');
      const key = e.target.value.toLowerCase();
      const filtered = allRecords.filter(r => ((r.workName||'').toLowerCase().includes(key) || (r.prNo||'').toLowerCase().includes(key) || (r.sendTo||'').toLowerCase().includes(key)));
      renderRecords(filtered);
    });

    // Show main view
    window.showMainView = function(viewName){
      if(viewName === 'progress'){
        pdfView.classList.remove('active');
        progressView.classList.add('active');
        viewTabPdf.classList.remove('active');
        viewTabProgress.classList.add('active');
        // mobile button states
        if(window.innerWidth <= 768){
          mobileFilterBtn.style.display = 'none';
          mobileDailyFilterBtn.style.display = 'block';
        }
        loadDailyProgressDates();
      } else {
        pdfView.classList.add('active');
        progressView.classList.remove('active');
        viewTabPdf.classList.add('active');
        viewTabProgress.classList.remove('active');
        if(window.innerWidth <= 768){
          mobileFilterBtn.style.display = 'block';
          mobileDailyFilterBtn.style.display = 'none';
        }
      }
    }

    // filtering & accordion
    function clearPdfNavActive(){
      pdfNav.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    }
    window.filterRecords = function(subDiv, type, btn){
      clearPdfNavActive();
      if(btn) btn.classList.add('active');
      const header = btn?.closest?.('.pdf-nav-section')?.querySelector('.pdf-nav-header');
      if(header) header.classList.add('active');
      const filtered = allRecords.filter(r => r.subDivision === subDiv && r.recordType === type);
      renderRecords(filtered);
      // if mobile ‚Äî close sidebar after selecting
      if(window.innerWidth <= 768){
        pdfNav.classList.remove('active');
      }
    };
    window.togglePdfNav = function(headerButton){
      headerButton.classList.toggle('active');
      const content = headerButton.nextElementSibling;
      if(content) content.classList.toggle('active');
    };
    window.showAllPDFs = function(btn){
      clearPdfNavActive();
      if(btn) btn.classList.add('active');
      renderRecords(allRecords);
      if(window.innerWidth <= 768) pdfNav.classList.remove('active');
    };

    // PDF modal logic (redesigned close etc)
    const productModal = document.getElementById('productModal');
    const modalName = document.getElementById('modalName');
    const modalPR = document.getElementById('modalPR');
    const pdfFrame = document.getElementById('pdfFrame');
    const closeModalBtn = document.getElementById('closeModal');
    const modalToolbar = document.getElementById('modalToolbar');
    const openInNewBtn = document.getElementById('openInNewBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    window.showPDF = function(record){
      const { pdfPath, workName, prNo } = record || {};
      let path = pdfPath;
      if(!path) return alert("No PDF associated with this record.");
      if(!path.startsWith("/uploads/")) path = "/uploads/" + path.replace(/^uploads[\\/]/,'');
      modalName.textContent = workName || 'PDF';
      modalPR.textContent = "PR No: " + (prNo || 'N/A');
      pdfFrame.src = `${SERVER_URL}${path}`;
      productModal.classList.add('active');
      productModal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';

      // setup toolbar buttons (open/download) ‚Äî safe fallbacks
      openInNewBtn.onclick = ()=> window.open(`${SERVER_URL}${path}`, '_blank');
      downloadBtn.onclick = ()=> {
        const a = document.createElement('a');
        a.href = `${SERVER_URL}${path}`;
        a.download = (prNo || 'document') + '.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
      };

      // show toolbar on mobile
      if(window.innerWidth <= 768){
        modalToolbar.style.display = 'flex';
        document.querySelector('.drag-handle').style.display = 'block';
      } else {
        modalToolbar.style.display = 'none';
        document.querySelector('.drag-handle').style.display = 'none';
      }
    };

    function closeModal(){
      productModal.classList.remove('active');
      productModal.setAttribute('aria-hidden','true');
      pdfFrame.src = 'about:blank';
      document.body.style.overflow = 'auto';
    }
    closeModalBtn.addEventListener('click', closeModal);

    // clicking outside modal content closes on mobile for easier UX
    productModal.addEventListener('click', (e)=>{
      if(window.innerWidth <= 768){
        if(e.target === productModal) closeModal();
      }
    });

    // daily progress code (unchanged logic)
    async function loadDailyProgressDates(){
      const dateList = document.getElementById('inlineDateList');
      try {
        const res = await fetch(`${SERVER_URL}/daily-progress`);
        const snapshots = await res.json();
        if(!snapshots.length){ dateList.innerHTML = "<p>No snapshots found.</p>"; return; }
        snapshots.sort((a,b)=> (b.date||'').localeCompare(a.date));
        dateList.innerHTML = snapshots.map(s=>`<button class="date-list-item" onclick="loadInlineSnapshot(${s.id}, '${s.date}', this)">${s.date} (${s.rowCount} rows)</button>`).join('');
      } catch(e){
        console.error("Failed to load snapshots:", e);
        dateList.innerHTML = "<p style='color:red'>Error loading dates.</p>";
      }
    }

    window.loadInlineSnapshot = async function(id, dateStr, btn){
      const title = document.getElementById('inlineSnapshotTitle');
      const frame = document.getElementById('inlineSnapshotFrame');
      const printBtn = document.getElementById('inlinePrintBtn');

      document.querySelectorAll('.date-list-item').forEach(b=>b.classList.remove('active'));
      if(btn) btn.classList.add('active');

      title.textContent = 'Loading...';
      frame.innerHTML = "<p>Loading snapshot...</p>";
      printBtn.style.display = 'none';

      try {
        const res = await fetch(`${SERVER_URL}/daily-progress/${id}`);
        if(!res.ok) throw new Error('Snapshot not found');
        const snapshot = await res.json();

        const thead = `<tr>
          <th style="width:120px">Date</th><th style="width:120px">Division</th>
          <th style="width:160px">Sub-Division/Location</th><th style="min-width:500px">Maintenance Activity Description</th>
          <th style="width:140px">Man Power Engaged</th><th style="width:140px">Status</th><th style="min-width:200px">Remarks/Issues</th>
        </tr>`;

        title.textContent = `Daily Progress on: ${snapshot.date}`;
        frame.innerHTML = `<table id="previewTable"><thead>${thead}</thead><tbody>${snapshot.tableHTML}</tbody></table>`;
        printBtn.style.display = 'block';

        // minor cleaning (same as before)
        const rows = frame.querySelectorAll('#previewTable tbody tr');
        let prevDate = null;
        rows.forEach(tr=>{
          const dateCell = tr.children[0];
          const divisionCell = tr.children[1];
          if(dateCell){
            const cur = dateCell.textContent;
            if(cur === prevDate && divisionCell && divisionCell.textContent.trim()==='') dateCell.textContent = '';
            else if(cur.trim() !== '') prevDate = cur;
          }
          if(tr.lastElementChild) tr.removeChild(tr.lastElementChild);
        });
        frame.querySelectorAll('#previewTable td[contenteditable="true"]').forEach(td=>{
          td.removeAttribute('contenteditable');
          td.style.background = 'none';
        });

        // close the left pane on mobile so user sees the table
        if(window.innerWidth <= 768){
          document.getElementById('inlineLeftBar')?.classList?.remove('active');
        }
      } catch(err){
        console.error(err);
        title.textContent = 'Error';
        frame.innerHTML = `<p style='color:red;'>Error loading snapshot: ${err.message}</p>`;
      }
    };

    window.printDailyProgress = function(){
      const content = document.getElementById('inlineSnapshotFrame').innerHTML;
      const title = document.getElementById('inlineSnapshotTitle').textContent;
      const w = window.open('','print','height=800,width=1000');
      w.document.write('<html><head><title>Print Snapshot</title>');
      w.document.write(`<style>body{font-family:Arial}table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:8px;text-align:left}</style>`);
      w.document.write('</head><body>');
      w.document.write(`<h3>${title}</h3>`);
      w.document.write(content);
      w.document.write('</body></html>');
      w.document.close();
      w.focus();
      setTimeout(()=>{ w.print(); w.close(); },250);
    };

    // password modal helpers
    window.openPasswordModal = function(){ document.getElementById('passwordModal').style.display='flex'; document.getElementById('usernameInput').focus(); }
    window.closePasswordModal = function(){ document.getElementById('passwordModal').style.display='none'; document.getElementById('usernameInput').value=''; document.getElementById('passwordInput').value=''; }
    document.getElementById('passwordInput').addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); verifyPassword(); }})

    window.verifyPassword = async function(){
      const username = document.getElementById('usernameInput').value.trim();
      const pass = document.getElementById('passwordInput').value.trim();
      if(!username || !pass){ alert('Please enter a username and password.'); return; }
      try{
        const res = await fetch(`${SERVER_URL}/login`, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username, password: pass })});
        if(res.ok){
          const data = await res.json();
          localStorage.setItem('adminToken', data.token);
          closePasswordModal();
          window.location.href = 'add-product.html';
        } else {
          const err = await res.json();
          alert('‚ùå ' + (err.message || 'Incorrect username or password!'));
        }
      } catch(e){
        console.error('Login error', e);
        alert('‚ö†Ô∏è Could not connect to the login server.');
      }
    };

    // Mobile sidebar toggles (slide-in from LEFT)
    function toggleSidebar(buttonId, sidebarId){
      const btn = document.getElementById(buttonId);
      const sidebar = document.getElementById(sidebarId);
      if(!btn || !sidebar) return;
      btn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        // toggle active class which moves sidebar in
        const active = sidebar.classList.toggle('active');
        // for accessibility aria-hidden
        sidebar.setAttribute('aria-hidden', (!active).toString());
      });
      // click outside closes
      document.addEventListener('click', (e)=>{
        if(!sidebar.classList.contains('active')) return;
        if(sidebar.contains(e.target) || btn.contains(e.target)) return;
        sidebar.classList.remove('active');
        sidebar.setAttribute('aria-hidden','true');
      });
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      toggleSidebar('mobileFilterBtn','pdf-nav-bar');
      toggleSidebar('mobileDailyFilterBtn','inlineLeftBar');
    });

    // Scroll to top behaviour
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    const rightPanels = document.querySelectorAll('.right-panel');
    rightPanels.forEach(p=>{
      p.onscroll = ()=> { scrollTopBtn.style.display = p.scrollTop > 240 ? 'block' : 'none'; }
    });
    scrollTopBtn.addEventListener('click', ()=>{
      document.getElementById('pdf-grid-wrapper').scrollTo({ top: 0, behavior: 'smooth' });
      document.getElementById('inlineRightBar')?.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // global key: esc closes modal & sidebar
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){ closeModal(); document.querySelectorAll('.left-bar.active').forEach(el=>el.classList.remove('active')); }
    });

    // initialize
    window.addEventListener('load', loadRecords);

  </script>
</body>
</html>
