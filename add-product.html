<!DOCTYPE html>
<html lang="en">
<head>
    <script>
     const token = localStorage.getItem("adminToken");
const isAdmin = localStorage.getItem("isAdmin");

// Prevent redirect loop if user logged out manually
const loggedOut = sessionStorage.getItem("loggedOut");

if (!token || isAdmin !== "true") {

    // If user manually logged out ‚Üí DO NOT auto-login ‚Üí go to login page normally
    if (loggedOut) {
        window.location.href = "login.html";
    }

    // If Remember Me login exists ‚Üí auto-login
    const rememberToken = localStorage.getItem("rememberToken");
    if (rememberToken) {
        localStorage.setItem("adminToken", rememberToken);
        localStorage.setItem("isAdmin", "true");
    } else {
        alert("You must be logged in to access this page.");
        window.location.href = "login.html";
    }
}

// Clear logout flag
sessionStorage.removeItem("loggedOut");

    </script>
    <meta charset="UTF-8" />
    <title>Admin - PDF Database + Daily Progress</title>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    body { font-family: Arial; background:#f4f4f4; padding:20px; margin:0; }
    header { background:#232f3e; color:white; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:1.25rem; }
    header .buttons { display:flex; gap:10px; }
    header button { background:#dc3545; border:none; color:white; padding:8px 14px; border-radius:5px; cursor:pointer; font-weight:bold; }
    .btn-clear { background:#6c757d; color:white; }
        
    .btn-export { background: #1D6F42; color: white; }
    .btn-import-label { 
        background: #6f42c1;
        color: white; 
        cursor: pointer; 
        padding: 6px 10px; 
        border-radius: 6px; 
        font-size: 0.9rem;
        display: inline-block;
    }
    .container { 
        max-width: 1800px; 
        width: 95%;      
        margin: 20px auto; 
    }

#estimateListTable {
    table-layout: fixed !important;
       /* wide full table */
}
#estimateListTable th:nth-child(2),
#estimateListTable td:nth-child(2) {
    width: 500px !important;     
    max-width: 500px !important;
    min-width: 500px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
}
#estimateListTable thead th {
    white-space: normal !important;
}



        
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab-btn { padding:8px 14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; background:white; }
    .tab-btn.active { background:#007bff; color:white; border-color:#007bff; }
    .panel { background:white; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.06); display:none; }
    .panel.active { display:block; }
    
    label { display: inline-block;
    margin-top: 10px;
    font-weight: bold;
    margin-right: 13px; }
    input, select, textarea { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box; }
    textarea { min-height:80px; resize:vertical; }
    .flex-row { display:flex; gap:12px; }
    .col { flex:1; }
    button.primary { margin-top:12px; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#28a745; color:white; }
    button.secondary { background:#007bff; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:15px; display:block; overflow:auto; max-height:420px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; vertical-align:top; }
    th { background:#f0f0f0; position:sticky; top:0; z-index:2; }
    th.wrap { cursor: pointer; } 
    tr:nth-child(even) { background:#fafafa; }
    
    td.wrap, th.wrap { white-space:normal; word-break:break-word; word-wrap:break-word; }
    
    .actions { 
        display:flex; 
        gap: 4px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .small-btn { 
        padding: 5px 7px;
        font-size: 0.8rem;
        border-radius:4px; border:none; cursor:pointer; font-weight:bold; 
        flex-shrink: 0;
    }
    
    .preview-btn { background:#ff9900; color:white; }
    .edit-btn { background:#007bff; color:white; }
    .delete-btn { background:#dc3545; color:white; }
    .download-btn { background:#28a745; color:white; }
    
    .restore-btn { background: #28a745; color:white; }
    
    th:last-child, td:last-child {
        min-width: 180px;
    }

    #messageBox { margin-top:10px; font-weight:bold; color:green; }
    
    .modal-overlay {
        display:none; 
        position:fixed; 
        top:0; left:0; 
        width:100%; height:100%; 
        background:rgba(0,0,0,0.6); 
        backdrop-filter:blur(4px); 
        justify-content:center; 
        align-items:center; 
        z-index:1000;
        animation: fadeIn 0.2s ease-out;
    }
/* === PDF ENTRY GRID (PR REGISTER STYLE) === */
#pdfEntryWrapper {
    margin-top: 20px;
    padding: 15px;
    border-radius: 10px;
    background: #ffffff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06);
}

#pdfEntryControls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

#pdfEntryControls .small {
    font-size: 0.85rem;
}

#pdfEntryTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

#pdfEntryTable thead th {
    background: #0d8ebb;           /* Excel-like blue */
    color: #ffffff;
    padding: 8px 6px;
    text-align: left;
    border: 1px solid #cde8f2;
    position: sticky;
    top: 0;
    z-index: 1;
    white-space: nowrap;
}

#pdfEntryTable tbody td {
    border: 1px solid #e0e0e0;
    padding: 6px 6px;
    vertical-align: top;
    background: #fdfdfd;
}

#pdfEntryTable tbody tr:nth-child(even) td {
    background: #f7fbff;          /* light alt row like daily progress */
}

#pdfEntryTable td[contenteditable="true"] {
    background: #fffdf0;          /* light yellow like editable daily grid */
    outline: none;
}

#pdfEntryTable td[contenteditable="true"]:focus {
    box-shadow: inset 0 0 0 1px #007bff;
    background: #fffbe7;
}

.pdf-file-input {
    width: 150px;
    font-size: 12px;
}

.save-row-btn {
    background: #28a745;
    color: #fff;
}

/* Main table scroll area */
#estimateListTable {
    table-layout: fixed;
    width: 2000px;   /* Expand table width */
}

/* Column width customisation */
#estimateListTable th:nth-child(1), 
#estimateListTable td:nth-child(1) {
    width: 60px;    /* S.No */
}

#estimateListTable th:nth-child(2), 
#estimateListTable td:nth-child(2) {
    width: 450px;    /* Description of Work ‚Äì WIDE */
    white-space: normal; 
}

#estimateListTable th:nth-child(3),
#estimateListTable td:nth-child(3),
#estimateListTable th:nth-child(4),
#estimateListTable td:nth-child(4) {
    width: 120px;  /* Division + PR No */
}

#estimateListTable th:nth-child(5),
#estimateListTable td:nth-child(5) {
    width: 200px;  /* Estimate Sanction No */
}

#estimateListTable th:nth-child(6),
#estimateListTable td:nth-child(6) {
    width: 150px; /* T Spec No */
}

#estimateListTable th:nth-child(7),
#estimateListTable td:nth-child(7) {
    width: 180px;  /* Firm / Contractor */
}

#estimateListTable th:nth-child(8),
#estimateListTable td:nth-child(8) {
    width: 130px;  /* PO No */
}

#estimateListTable th:nth-child(9),
#estimateListTable td:nth-child(9),
#estimateListTable th:nth-child(10),
#estimateListTable td:nth-child(10) {
    width: 150px; /* Gross + Net Amount */
}

#estimateListTable th:nth-child(11),
#estimateListTable td:nth-child(11),
#estimateListTable th:nth-child(12),
#estimateListTable td:nth-child(12),
#estimateListTable th:nth-child(13),
#estimateListTable td:nth-child(13) {
    width: 140px;  /* LOA, SAP Billing, M Book */
}

#estimateListTable th:nth-child(14),
#estimateListTable td:nth-child(14) {
    width: 120px; /* Reg Pg No */
}

#estimateListTable th:nth-child(15),
#estimateListTable td:nth-child(15) {
    width: 140px; /* Back Charging */
}

#estimateListTable th:nth-child(16),
#estimateListTable td:nth-child(16) {
    width: 200px; /* Start & Completion Dates */
}

#estimateListTable th:nth-child(17),
#estimateListTable td:nth-child(17),
#estimateListTable th:nth-child(18),
#estimateListTable td:nth-child(18) {
    width: 130px; /* LOA No 2 + Actions */
}

/* Make long text wrap nicely */
#estimateListTable td {
    white-space: normal; 
    word-wrap: break-word;
}



        
.table-scroll {
    width: 100%;
    /* max-height: 420px; */
    overflow-y: auto !important;
    /* overflow-x: hidden !important; */
    border: 1px solid #ddd;
    border-radius: 6px;
    display: block;
    /* padding-bottom: 15px; */
    /* overflow: auto; /* removes scrollbar overlay issue */
}

/* Critical ‚Äî prevents horizontal overflow */
.table-scroll table {
    width: 100% !important;
    table-layout: fixed !important;
}


.clear-row-btn {
    background: #6c757d;
    color: #fff;
    margin-left: 4px;
}

    #previewModalContent { background:white; border-radius:10px; max-width:95%; width:1000px; height:90%; position:relative; padding:10px; display:flex; flex-direction:column; }
    #previewModalContent button.closeBtn { position:absolute; top:10px; right:10px; background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; z-index: 10; }
    #pdfFrame { flex:1; width:100%; border:none; border-radius:8px; }

    
    /* --- Modal Preview Fix --- */
    #snapshotPreviewContent { 
        background: white; 
        border-radius: 10px; 
        max-width: 95%; 
        width: 1200px; 
        max-height: 90%; 
        position: relative; 
        padding: 0;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    #snapshotPreviewContent .modal-controls { 
        display:flex; 
        gap:10px; 
        justify-content:flex-end; 
        border-bottom: 1px solid #ccc;
        padding: 20px 20px 10px 20px;
        background: white;
        z-index: 10;
        flex-shrink: 0;
    }
    #snapshotPreviewContent .modal-controls button { padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
    #snapshotPreviewContent .print-btn { background: #007bff; color: white; }
    #snapshotPreviewContent .closeBtn { background: #dc3545; color: white; }
    
    #snapshotFrame { 
        width: 100%;
        border: none; 
        margin: 0;
        padding: 10px 20px 20px 20px;
        box-sizing: border-box;
        background: #ffffff; 
        color: #000000;
        overflow: auto;
        flex-grow: 1;
    }
    
    #snapshotFrame table {
        width: auto;
        min-width: 100%;
        border-collapse: collapse;
        color: #000000;
    }
    /* --- End Modal Preview Fix --- */

    #snapshotFrame th, #snapshotFrame td { border:1px solid #ccc; padding:8px; text-align:left; vertical-align:top; white-space:normal; word-break:break-word; }
    #snapshotFrame th { background:#f0f0f0; position:static; }
    #snapshotFrame td button { display: none; } 
    #snapshotFrame td[contenteditable="true"] { background: none; }

    #progressTable, #savedProgressTable { width: 100%; border-collapse: collapse; margin-top: 10px; }
    #progressTable th, #progressTable td, #savedProgressTable th, #savedProgressTable td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; white-space: normal; min-width: 120px; }
    #progressTable td[contenteditable="true"] { background: #fffbe7; outline: none; min-height: 28px; }
    #progressTable th { background: #eaeaea; position: sticky; top: 0; }
    #savedProgressTable th { background: #f5f5f5; }
    .sheet-controls { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .small { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
    .btn-add { background:#28a745; color:white; }
    .btn-save { background:#007bff; color:white; }
    .btn-clear { background:#6c757d; color:white; }
    
    .search-row { display:flex; gap:8px; margin-top:10px; align-items:center; flex-wrap: wrap; }
    
    .muted { color:#666; font-size:0.9rem; }
/* --- NEW: Daily Progress Controls (Professional Look) --- */
.sheet-controls {
    display: flex;
    flex-wrap: wrap; /* Allows groups to stack on small screens */
    align-items: flex-end; /* Aligns all groups to the bottom */
    gap: 15px; /* Space between groups */
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #eee;
    margin-bottom: 15px; /* Space before table */
}

/* Modern CL Records Table */
#clTableContainer {
    margin-top: 20px;
    padding: 15px;
    border-radius: 10px;
    background: #ffffff;
    box-shadow: 0px 2px 10px rgba(0,0,0,0.08);
    overflow-x: auto;
}

#clTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

#clTable thead th {
    background-color: #007bff !important;
    color: white !important;
    font-weight: bold;
    text-align: left;
}

#clTable th, #clTable td {
    padding: 10px 12px;
    border-bottom: 1px solid #e0e0e0;
}

#clTable tr:hover {
    background: #f5f8ff;
}

/* Checkbox column */
#clTable th:first-child, 
#clTable td:first-child {
    text-align: center;
    width: 40px;
}

/* S.No column */
#clTable td:nth-child(2) {
    width: 50px;
    font-weight: bold;
}

/* Buttons */
.edit-btn, .delete-btn {
    padding: 6px 12px;
    font-size: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    transition: 0.2s ease;
}

.edit-btn {
    background: #28a745;
}

.edit-btn:hover {
    background: #1e7e34;
}

.delete-btn {
    background: #dc3545;
}

.delete-btn:hover {
    background: #b52a36;
}

/* Top buttons */
#clActions {
    margin: 15px 0;
}

#clActions .top-btn {
    padding: 7px 14px;
    font-size: 14px;
    background: #0056d2;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 10px;
}

#clActions .top-btn:hover {
    background: #003e9c;
}

/* No photo image */
.default-photo {
    width: 45px;
    height: 45px;
    border-radius: 5px;
    object-fit: cover;
    border: 1px solid #ccc;
}


        
/* Style for each group of buttons */
.control-group {
    display: flex;
    align-items: center; /* Align items within the group */
    gap: 8px; /* Space between buttons in a group */
    
    /* Add a nice visual separator */
    padding-left: 15px;
    border-left: 1px solid #ccc;
}

/* Remove border from the first group */
.control-group:first-child {
    border-left: none;
    padding-left: 0;
}

/* Fix for the date label and input */
.control-group .date-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
/* Standardize labels in the control bar */
.control-group label {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600; 
}
/* Standardize inputs in the control bar */
.control-group input[type="date"] {
    width: 160px;
    padding: 6px 10px;
    margin: 0; /* Remove default margin */
}
/* --- End of New CSS --- */
    .selected-row > td {
        background-color: #dbeafe !important;
    }
    .pagination-btn {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
        transition: background-color 0.2s;
    }
    .pagination-btn:hover {
        background-color: #5a6268;
    }

    #toastContainer {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .toast {
        background: #232f3e;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        font-weight: bold;
        opacity: 0;
        transform: translateX(100%);
        animation: slideIn 0.3s forwards, slideOut 0.5s 3.5s forwards;
    }
    .toast.error { background: #dc3545; }
    .toast.success { background: #28a745; }
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(100%); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(100%); }
    }

    .pdf-dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
.sortable {
    cursor: pointer;
    user-select: none;
}

.sortable:hover {
    background: #e6f0ff;
}

    .dash-box {
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
    .dash-box h4 { margin: 0 0 5px 0; font-size: 0.9rem; color: #555; }
    .dash-box p { margin: 0; font-size: 1.5rem; font-weight: bold; color: #007bff; }
    .filter-bar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        background: #f9f9f9;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        align-items: center;
    }
    .filter-bar select {
        width: auto;
        flex: 1;
        min-width: 150px;
        padding: 8px;
    }
    .filter-bar .small {
        padding: 8px 12px;
    }

    tr.status-done > td { background-color: #e6ffed !important; }
    tr.status-progress > td { background-color: #fff9e0 !important; }
    tr.status-pending > td { background-color: #ffebe6 !important; }
    tr.selected-row > td { background-color: #dbeafe !important; }

    #formToggle {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 12px 18px;
        font-size: 1.25rem;
        color: #232f3e;
        cursor: pointer;
        display: block;
        width: 100%;
        text-align: left;
        margin-top: 10px;
        margin-bottom: 15px;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        box-sizing: border-box;
    }
    #formToggle:hover {
        background-color: #e9e9e9;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    #confirmModalContent {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        max-width: 400px;
        width: 90%;
        animation: fadeIn 0.2s ease-out;
    }
    #confirmTitle {
        margin: 0;
        color: #232f3e;
    }
    #confirmMessage {
        margin: 15px 0;
        color: #333;
        font-size: 1rem;
    }

    #progressTable tbody tr.dragging {
        opacity: 0.5;
        background: #f0f8ff;
        border: 1px dashed #007bff;
    }
    #progressTable tbody tr {
        transition: background-color 0.2s ease;
    }
    #progressTable tbody tr:hover {
        background-color: #f5f5f5;
        cursor: move;
    }


    @media (max-width: 650px) {
        header { flex-direction: column; gap: 12px; align-items: flex-start; }
        header .buttons { width: 100%; justify-content: flex-start; }
    }
    @media (max-width: 400px) {
         .tabs { flex-direction: column; align-items: stretch; }
         .tab-btn { text-align: center; }
    }

/* -------- Global mobile basics -------- */
html, body {
    max-width: 100%;
    overflow-x: hidden;
}

/* ------------------ PAGE TITLE ------------------ */
#estimatePanel h2 {
    
    margin-top: 20px;
    color: #232f3e;
}

/* ------------------ TABLE WRAPPER ------------------ */
.table-wrapper {
    width: 98%;
    background: white;
    margin: 20px auto;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.15);
}

/* ------------------ ESTIMATE TABLE ------------------ */
#estimateTable {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

#estimateTable th {
    background: #9BBB59;
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    border: 1px solid #b2d48d;
}

#estimateTable td {
    border: 1px solid #ddd;
    padding: 9px;
    text-align: center;
    font-size: 14px;
}

#estimateTable tr:hover {
    background: #f1f7e6;
    transition: 0.2s;
}

/* ------------------ BUTTONS ------------------ */
.btn {
    background: #007bff;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
}

.btn:hover {
    background: #0056b3;
    transform: scale(1.05);
}

.delete-btn {
    background: #dc3545;
}

.delete-btn:hover {
    background: #b52a36;
}

/* ------------------ PRINT BUTTON ------------------ */
#printEstimateBtn {
    background: #ff9800;
    padding: 10px 16px;
    border-radius: 6px;
    font-weight: bold;
    color: white;
    border: none;
    cursor: pointer;
}

#printEstimateBtn:hover {
    background: #e68900;
    transform: scale(1.05);
}

/* ------------------ MOBILE RESPONSIVE ------------------ */
@media (max-width: 768px) {
    #estimateTable {
        font-size: 12px;
    }
    #estimateTable th,
    #estimateTable td {
        padding: 6px;
    }
    .table-wrapper {
        padding: 5px;
    }
}
        
/* -------- Mobile / small tablets -------- */
@media (max-width: 900px) {

    body {
        padding: 8px;
        background: #f4f4f4;
    }

    header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 10px 12px;
    }

    header h1 {
        font-size: 1.0rem;
        line-height: 1.3;
    }

    header .buttons {
        width: 100%;
        justify-content: flex-start;
        gap: 8px;
    }

    header .buttons button {
        padding: 6px 10px;
        font-size: 0.85rem;
    }

    .container {
        width: 100%;
        max-width: 100%;
        margin: 10px auto 40px;
        padding: 0;
    }

    /* Tabs ‚Üí horizontal scroll on small screens */
    .tabs {
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 4px;
    }
    .tab-btn {
        flex: 0 0 auto;
        font-size: 0.85rem;
        padding: 6px 10px;
    }

    /* Panels & cards a bit flatter on mobile */
    .panel {
        padding: 12px;
        border-radius: 8px;
        box-shadow: none;
    }

    #pdfEntryWrapper,
    #clTableContainer {
        padding: 10px;
        border-radius: 8px;
        box-shadow: none;
    }

    h2, h3 {
        font-size: 1rem;
    }

    .muted {
        font-size: 0.8rem;
    }

    /* Dashboard tiles ‚Äì 2 columns */
    .pdf-dashboard-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
    }
    .dash-box {
        padding: 10px;
    }
    .dash-box h4 {
        font-size: 0.8rem;
    }
    .dash-box p {
        font-size: 1.1rem;
    }

    /* Controls / buttons bar */
    .sheet-controls,
    #pdfEntryControls,
    .filter-bar,
    .search-row {
        padding: 8px;
        gap: 10px;
    }

    .small,
    .btn-import-label,
    .btn-add,
    .btn-save,
    .btn-clear,
    .btn-export {
        font-size: 0.8rem;
        padding: 6px 8px;
    }

    /* Generic scroll wrapper for big tables */
    .table-scroll {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Give tables a minimum width so they don‚Äôt squeeze too much.
       You‚Äôll scroll sideways to see all columns. */
    #pdfEntryTable,
    #progressTable,
    #savedProgressTable,
    #clTable,
    #pdfListTable {
        min-width: 900px;
    }

    /* Remove the fixed max-height on mobile ‚Äì scrolling the page is easier */
    table {
        max-height: none !important;
        display: table;
    }

    /* ‚ÄúAll records‚Äù pagination text smaller */
    #pageInfo,
    #savedPageInfo {
        font-size: 0.8rem;
    }
}

/* Extra-narrow phones */
@media (max-width: 480px) {
    header h1 {
        font-size: 0.9rem;
    }

    .tab-btn {
        font-size: 0.8rem;
    }

    .dash-box p {
        font-size: 1rem;
    }
}

 /* ================= MOBILE / TABLET LAYOUT ================= */

.desktop-only { display: block; }
.mobile-only { display: none; }

@media (max-width: 768px) {

  html, body {
    max-width: 100%;
    overflow-x: hidden;
  }

  body {
    padding: 0;
  }

  header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  header h1 {
    font-size: 1rem;
  }
  header .buttons {
    width: 100%;
    justify-content: flex-start;
    gap: 8px;
  }
  header .buttons button {
    padding: 6px 10px;
    font-size: 0.8rem;
  }

  .container {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 10px;
  }

  .tabs {
    overflow-x: auto;
    padding-bottom: 6px;
  }
  .tab-btn {
    flex: 1;
    white-space: nowrap;
    font-size: 0.85rem;
  }

  .panel {
    padding: 10px;
    box-shadow: none;
    border-radius: 6px;
  }

  /* Dashboard cards a bit more compact */
  .pdf-dashboard-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
  }
  .dash-box {
    padding: 10px;
  }
  .dash-box h4 {
    font-size: 0.75rem;
  }
  .dash-box p {
    font-size: 1.1rem;
  }

  /* PR entry & daily progress tables: make them scroll instead of shrinking */
  #pdfEntryWrapper > div,
  #progressTable,
  #savedProgressTable,
  #clTableContainer {
    overflow-x: auto;
  }
  #pdfEntryTable,
  #progressTable,
  #savedProgressTable,
  #clTable {
    min-width: 700px;        /* Don‚Äôt squeeze columns too much */
    font-size: 0.8rem;
  }

  /* Switch to mobile cards for lists */
  .desktop-only { display: none !important; }
  .mobile-only { display: block !important; }

  /* ====== ALL RECORDS ‚Äì MOBILE CARDS ====== */
  .record-card-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .record-card,
  .record-card-trash {
    background: #ffffff;
    border-radius: 10px;
    padding: 10px 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    font-size: 0.9rem;
  }

  .record-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
  }
  .record-name {
    font-weight: 650;
    color: #222;
    max-width: 70%;
  }
  .record-type {
    font-size: 0.75rem;
    padding: 3px 8px;
    border-radius: 999px;
    background: #e3f2fd;
    color: #0d47a1;
  }

  .record-meta {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 4px 10px;
    margin-bottom: 6px;
  }
  .record-meta-row {
    font-size: 0.78rem;
    color: #444;
  }
  .record-meta-label {
    font-weight: 600;
    color: #666;
    margin-right: 4px;
  }

  .record-send-to {
    font-size: 0.78rem;
    margin-bottom: 8px;
    color: #555;
  }

  .record-card-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 4px;
  }
  .record-card-actions .small-btn {
    flex: 1 1 45%;
    text-align: center;
    padding: 6px 8px;
    font-size: 0.8rem;
  }

  /* Trash cards */
  .record-card-trash-title {
    font-weight: 600;
    margin-bottom: 4px;
  }
  .record-card-trash-meta {
    font-size: 0.8rem;
    color: #555;
    margin-bottom: 6px;
  }
}
  #estimateEntryControls, 
#pdfEntryControls {
    display:flex;
    align-items:center;
    flex-wrap:wrap;
    gap:10px;
    margin-bottom:10px;
}

#estimateEntryTable thead th {
    position:sticky;
    top:0;
    background:#9BBB59;
    color:white;
    z-index:5;
}

#estimateListTable thead th {
    position:sticky;
    top:0;
    background:#4A7EBB;
    color:white;
}
     
</style>
</head>
<body>
    <header>
        <h1>üìÇ Admin - PDF Database + Daily Progress</h1>
        <div class="buttons">
            <button onclick="goHome()">üè† Home</button>
            <button onclick="logout()">üö™ Logout</button>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button id="tabPdf" class="tab-btn active" onclick="showPanel('pdf')">PDF Database</button>
            <button id="tabEstimate" class="tab-btn" onclick="showPanel('estimate')">Estimates</button>
            <button id="tabDaily" class="tab-btn" onclick="showPanel('daily')">Daily Work Progress</button>
            <button id="tabCL" class="tab-btn" onclick="showPanel('cl')">CL Bio Data</button>
        </div>

        <div id="pdfPanel" class="panel active">
            
            <h2>üìä Dashboard</h2>
            <div id="pdfDashboard" class="pdf-dashboard-grid">
                </div>
            
            <hr style="margin:20px 0;">

            <div>
    <h2>üßæ PR Register ‚Äì Add / Edit (Table View)</h2>

    <div id="pdfEntryWrapper">
        <div id="pdfEntryControls">
            <button class="small btn-add" type="button" onclick="addPdfRow()">‚ûï Add Row</button>
            <button class="small btn-clear" type="button" onclick="clearPdfGrid()">üßπ Clear Empty Rows</button>
             <label class="btn-import-label">
        üì• Import from Excel
        <input type="file" id="prImportFile" onchange="importPRFromExcel(event)" accept=".xlsx,.xls" style="display:none;">
    </label>
            <span class="muted">Fill any row(s) and click <b>Save Row</b>. Each row saves one PDF record.</span>
        </div>

        <div class="table-scroll">
        <table id="pdfEntryTable">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>PR No</th>
                        <th>Date</th>
                        <th>Procurement Description</th>
                        <th>Amount</th>
                        <th>Budget Head</th>
                        <th>PO No</th>
                        <th>Date 2</th>
                        <th>Name of the Firm</th>
                        <th>Division</th>
                        <th>Pg No</th>
                        <th>Remarks</th>
                        <th>High Value Spares</th>
                        <th>PDF File</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pdfEntryBody">
                    <!-- rows added by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

            <div> <h2 id="pdfListTitle">All Records</h2>
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="üîç Search records..." style="padding:8px; border-radius:5px; border:1px solid #ccc; flex:1; min-width:150px;">
                    <select id="filterSubDivision" style="padding:8px;"></select>
                    <select id="filterRecordType" style="padding:8px;"></select>
                    <button class="small btn-clear" onclick="resetAllFilters()">Reset</button>
                    
                    <button id="trashToggleBtn" class="small btn-clear" onclick="toggleTrashView()" style="background-color: #dc3545;">‚ôªÔ∏è View Trash</button>
                </div>

                <div style="display:flex; justify-content:flex-end; flex-wrap:wrap; margin-bottom:10px;">
                     <div style="margin-top:5px;">
        <label>Show entries
            <select id="pdfShowEntries" onchange="changePdfRowsPerPage()" style="padding:4px;">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
            </select>
        </label>
    
                    
                        <button class="pagination-btn" onclick="prevPage()">‚¨Ö Prev</button>
                        <span id="pageInfo" style="margin:0 10px;">Page 1</span>
                        <button class="pagination-btn" onclick="nextPage()">Next ‚û°</button>
                    </div>
                </div>
                <div class="table-scroll" style="border:1px solid #ddd; border-radius:6px;">
    <table id="pdfListTable">
        <thead>
            <tr id="pdfTableHead">
                <!-- filled by JS -->
            </tr>
        </thead>
        <tbody id="recordTable"></tbody>
    </table>
</div>

            </div>

        </div> 

        
       <div id="estimatePanel" class="panel">


           <h2>üìä Estimates Dashboard</h2>

<div id="estimateDashboard" class="pdf-dashboard-grid">
    <div class="dash-box">
        <h3>Total Estimates</h3>
        <p id="estTotalCount">0</p>
    </div>

    <div class="dash-box">
        <h3>Total Gross Amount</h3>
        <p id="estTotalGross">‚Çπ0</p>
    </div>

    <div class="dash-box">
        <h3>Total Net Amount</h3>
        <p id="estTotalNet">‚Çπ0</p>
    </div>

    <div class="dash-box">
        <h3>Divisions</h3>
        <p id="estDivisions">0</p>
    </div>
</div>

<hr style="margin:20px 0;">

<h2>üìò Estimate Register ‚Äì Add / Edit (Table View)</h2>
    <div id="estimateEntryWrapper" style="
    margin-top: 20px;
    padding: 15px;
    border-radius: 10px;
    background: #ffffff;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);">
        <div id="estimateEntryControls">
            <button class="small btn-add" type="button" onclick="addEstimateRow()">‚ûï Add Row</button>

            <button class="small btn-clear" type="button" onclick="clearEstimateEmptyRows()">üßπ Clear Empty Rows</button>

            <label class="btn-import-label">
                üì• Import from Excel
                <input type="file" id="estimateImportFile" onchange="importEstimateFromExcel(event)" accept=".xlsx,.xls" style="display:none;">
            </label>

            <span class="muted">Fill any row(s) and click <b>Save Row</b>. Each row saves one Estimate record.</span>
        </div>

        <div class="table-scroll">

            <table id="estimateEntryTable">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Description of the Work</th>
                        <th>Division</th>
                        <th>PR No</th>
                        <th>Estimate Sanction No</th>
                        <th>T. Spec No</th>
                        <th>Firm / Contractor</th>
                        <th>PO No</th>
                        <th>Gross Amount</th>
                        <th>Amount Excluding EPF/ESI/GST</th>
                        <th>LOA No</th>
                        <th>SAP Billing Doc</th>
                        <th>M-Book No</th>
                        <th>Reg Pg No</th>
                        <th>Back Charging</th>
                        <th>Start + Completion Dates</th>
                        <th>LOA No 2</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody id="estimateEntryBody">
                    <!-- Rows will be added by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <hr style="margin:30px 0; border:0; border-top:1px solid #eee;">

    <h2 id="estimateListTitle">All Estimate Records</h2>

    <div class="filter-bar">
        <input type="text" id="estimateSearchInput" placeholder="üîç Search..." style="padding:8px; border-radius:5px; border:1px solid #ccc; flex:1; min-width:150px;">
        
        <select id="filterEstimateDivision" style="padding:8px;"></select>
        <select id="filterEstimateType" style="padding:8px;"></select>

        <button class="small btn-clear" onclick="resetEstimateFilters()">Reset</button>

        <button id="estimateTrashToggleBtn" class="small btn-clear" onclick="toggleEstimateTrashView()" style="background-color:#dc3545;">
            ‚ôªÔ∏è View Trash
        </button>
    </div>

    <div style="display:flex; justify-content:flex-end; flex-wrap:wrap; margin-bottom:10px;">
        <div style="margin-top:5px;">
        <label>Show entries
    <select id="estimateShowEntries" onchange="changeEstimateRowsPerPage()" style="padding:4px;">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="500">500</option>
        <option value="1000">1000</option>
    </select>
</label>

        
            <button class="pagination-btn" onclick="estimatePrevPage()">‚¨Ö Prev</button>
            <span id="estimatePageInfo" style="margin:0 10px;">Page 1</span>
            <button class="pagination-btn" onclick="estimateNextPage()">Next ‚û°</button>
        </div>
    </div>

    <div class="table-scroll" style="border:1px solid #ddd; border-radius:6px;">
        <table id="estimateListTable">
            <thead>
                <tr id="estimateTableHead">
                    <!-- Filled by JS -->
                </tr>
            </thead>

            <tbody id="estimateListBody">
                <!-- Filled by JS -->
            </tbody>
        </table>
    </div>

</div>


        <div id="dailyPanel" class="panel">
            <h2>üßæ Daily Work Progress - Update/Edit</h2>
           <div class="sheet-controls">
            
            <div class="control-group">
                <div class="date-group">
                    <label for="snapshotDate">Progress Date:</label>
                    <input type="date" id="snapshotDate">
                </div>
            </div>

            <div class="control-group">
                <button class="small btn-add" onclick="addProgressRow()">‚ûï Add Row</button>
                <button class="small btn-add" onclick="insertRowBefore()">‚¨ÜÔ∏è Insert Row Before</button>
            <button class="small btn-add" onclick="insertRowAfter()">‚¨áÔ∏è Insert Row After</button>
            </div>
        
            <div class="control-group">
                <button class="small btn-save" onclick="saveProgress()">üíæ Save Progress</button>
                <button class="small btn-save" style="background-color: #ff9900;" onclick="saveDraft()">üìù Save Draft</button>
                <button class="small btn-clear" onclick="clearSheet()">üßπ Clear Sheet</button>
            </div>
            
            <div class="control-group">
                <button class="small btn-export" onclick="exportToExcel()">üì§ Export to Excel</button>
                <label for="importFile" class="btn-import-label">üì• Import from Excel</label>
                <input type="file" id="importFile" onchange="importFromExcel(event)" accept=".xlsx, .xls" style="display: none;">
            </div>
        
            <div class="control-group">
                <button class="small btn-merge" onclick="mergeCells()">üîÄ Merge Selected</button>
                <button class="small btn-unmerge" onclick="unmergeCells()">‚Ü©Ô∏è Unmerge</button>
            </div>
            
            <input type="hidden" id="snapshotId">
            
            <span id="autoSaveMsg" class="muted" style="margin-left: auto;"></span>
        </div>
            
            <div class="table-scroll" style="overflow:auto; border:1px solid #ddd; border-radius:6px;">
                <table id="progressTable" aria-label="Editable daily progress sheet">
                    <thead>
                        <tr>
                            <th style="width:100px">Date</th>
                            <th style="width:100px">Division</th>
                            <th style="width:140px">Sub-Division/Location</th>
                            <th style="min-width:300px">Maintenance Activity Description</th>
                            <th style="width:120px">Man Power Engaged</th>
                            <th style="width:120px">Status</th>
                            <th style="min-width:200px">Remarks/Issues</th>
                            <th style="width:80px">Row</th>
                        </tr>
                    </thead>
                    <tbody id="progressTableBody">
                    </tbody>
                </table>
            </div>

            <h3 style="margin-top:18px;">üìã Saved Daily Progress Reports (Archive)</h3>
            <div class="search-row">
                <input type="text" id="savedSearch" placeholder="üîç Search by date..." style="padding:8px; border-radius:5px; border:1px solid #ccc; flex:1;">
                <div>
                    <button class="small" onclick="prevSavedPage()">‚¨Ö Prev</button>
                    <span id="savedPageInfo" style="margin:0 8px">Page 1</span>
                    <button class="small" onclick="nextSavedPage()">Next ‚û°</button>
                </div>
            </div>
            <div class="table-scroll" style="overflow:auto; margin-top:8px; border:1px solid #eee; border-radius:6px;">
                <table id="savedProgressTable" aria-label="Saved daily progress snapshots">
                    <thead>
                        <tr>
                            <th style="width:400px">Snapshot Date</th>
                            <th style="width:400px">Row Count</th>
                            <th style="min-width:500px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="savedBody"></tbody>
                </table>
            </div>
        </div>
    </div> 
    
    <div id="previewModal" class="modal-overlay">
        <div id="previewModalContent">
            <button class="closeBtn" onclick="closePreview()">X</button>
            <iframe id="pdfFrame"></iframe>
        </div>
    </div>

    <div id="snapshotPreviewModal" class="modal-overlay">
        <div id="snapshotPreviewContent">
            <div class="modal-controls">
                <button class="print-btn" onclick="printSnapshot()">üñ®Ô∏è Print</button>
                <button class="closeBtn" onclick="closeSnapshotPreview()">X</button>
            </div>
            <div id="snapshotFrame">
            </div>
        </div>
    </div>

    <div id="clPanel" class="panel">
    <h2>üë∑ CL Bio Data Management</h2>

    <form id="clForm" enctype="multipart/form-data">
        <input type="hidden" id="clId">

        <label>Name</label>
        <input type="text" id="clName" required>

        <label>Gender</label>
        <select id="clGender">
            <option>Male</option>
            <option>Female</option>
        </select>

        <label>Aadhar</label>
        <input type="text" id="clAadhar">

        <label>Phone</label>
        <input type="text" id="clPhone">

        <label>Station</label>
        <input type="text" id="clStation">

        <label>Division</label>
        <input type="text" id="clDivision">

        <label>Date of Joining</label>
        <input type="text" id="clDoj">

        <label>Date of Birth</label>
        <input type="text" id="clDob">

        <label>Wages</label>
        <input type="text" id="clWages">

        <label>Nominee</label>
        <input type="text" id="clNominee">

        <label>Relation</label>
        <input type="text" id="clRelation">

        <label>Photo</label>
        <input type="file" id="clPhoto" accept="image/*">

        <button type="submit" class="primary">Save CL Data</button>
    </form>

    <hr>

    <h3>All CL Records</h3>

<div id="clActions">
    <button class="top-btn" onclick="editSelected()">Edit</button>
    <button class="top-btn" onclick="deleteSelected()">Delete</button>
</div>

<div id="clTableContainer" class="table-scroll">
    <table id="clTable">
        <thead>
            <tr>
                <th><input id="selectAll" type="checkbox" onclick="toggleSelectAll(this)"></th>
                <th>S.No</th>
                <th>Name</th>
                <th>Gender</th>
                <th>Aadhar</th>
                <th>Phone</th>
                <th>Station</th>
                <th>Division</th>
                <th>Date of Joining</th>
                <th>Date of Birth</th>
                <th>Wages</th>
                <th>Nominee</th>
                <th>Relation</th>
                <th>Photo</th>
            </tr>
        </thead>
        <tbody id="clTableBody"></tbody>
    </table>
</div>
    </div>
        <!-- ================= CONFIRM MODAL (REQUIRED) ================= -->
<div id="confirmModal" class="modal-overlay">
    <div id="confirmModalContent">
        <h3 id="confirmTitle">Confirm</h3>
        <p id="confirmMessage"></p>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button id="confirmBtnCancel" class="small btn-clear">Cancel</button>
            <button id="confirmBtnOk" class="small delete-btn">OK</button>
        </div>
    </div>
</div>
<!-- ================= END CONFIRM MODAL ================= -->


    <div id="toastContainer"></div>


    <script>
        
const API = "https://nttps-backend.onrender.com";

        let savedEntries = [];
        let savedFiltered = [];
        let savedPage = 1;
        const savedPerPage = 8;
        
// Safe auth wrapper for all API calls
async function authFetch(url, options = {}) {
  // Always read the latest token from localStorage
  const token = localStorage.getItem("adminToken");
  const headers = new Headers(options.headers || {});

  // Attach token if present
  if (token) {
    headers.set("Authorization", `Bearer ${token}`);
  }

  // Only set JSON header when not sending FormData
  const isFormData = options.body instanceof FormData;
  if (!isFormData && !headers.has("Content-Type")) {
    headers.set("Content-Type", "application/json");
  }

  const res = await fetch(url, { ...options, headers });

  // 401 ‚Üí real session expired ‚Üí logout
  if (res.status === 401) {
    showToast("Session expired. Please log in again.", true);
    setTimeout(logout, 1500);
  }
  // 403 ‚Üí forbidden, but DON'T auto logout (just show message)
  else if (res.status === 403) {
    showToast("Forbidden (403): check that you are logged in and token is valid.", true);
  }

  return res;
}
        /* ----------------- Tab switching ----------------- */
        function showPanel(name) {
    // Hide all
    confirmModal.style.display = "none";
    onConfirmCallback = null;
            
    document.getElementById('pdfPanel').classList.remove('active');
    document.getElementById('estimatePanel').classList.remove('active');
    document.getElementById('dailyPanel').classList.remove('active');
    document.getElementById('clPanel').classList.remove('active');

    // Reset tab highlights
    document.getElementById('tabPdf').classList.remove('active');
    document.getElementById('tabEstimate').classList.remove('active');
    document.getElementById('tabDaily').classList.remove('active');
    document.getElementById('tabCL').classList.remove('active');

    // Activate correct panel
    if (name === 'pdf') {
        document.getElementById('pdfPanel').classList.add('active');
        document.getElementById('tabPdf').classList.add('active');
    }

    else if (name === 'estimate') {
    document.getElementById('estimatePanel').classList.add('active');
    document.getElementById('tabEstimate').classList.add('active');
        loadEstimateDashboard();
   }

    else if (name === 'daily') {
        document.getElementById('dailyPanel').classList.add('active');
        document.getElementById('tabDaily').classList.add('active');
        loadSavedProgress();
    }
    else if (name === 'cl') {
        document.getElementById('clPanel').classList.add('active');
        document.getElementById('tabCL').classList.add('active');
        ;
    }
}


document.getElementById("clForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const formData = new FormData();
    formData.append("id", document.getElementById("clId").value);
    formData.append("name", document.getElementById("clName").value);
    formData.append("gender", document.getElementById("clGender").value);
    formData.append("aadhar", document.getElementById("clAadhar").value);
    formData.append("phone", document.getElementById("clPhone").value);
    formData.append("station", document.getElementById("clStation").value);
    formData.append("division", document.getElementById("clDivision").value);
    formData.append("doj", document.getElementById("clDoj").value);
    formData.append("dob", document.getElementById("clDob").value);
    formData.append("wages", document.getElementById("clWages").value);
    formData.append("nominee", document.getElementById("clNominee").value);
    formData.append("relation", document.getElementById("clRelation").value);

    // If editing ‚Üí keep previous photo URL
    const oldPhoto = document.getElementById("clPhoto").dataset.old;
    if (oldPhoto) formData.append("photoUrl", oldPhoto);

    const file = document.getElementById("clPhoto").files[0];
    if (file) formData.append("photo", file);

    const res = await authFetch(`${API}/cl`, {
        method: "POST",
        body: formData
    });

    const data = await res.json();
    if (data.success) {
        showToast("CL record saved");
        loadCLData();
        document.getElementById("clForm").reset();
        document.getElementById("clId").value = "";
    }
});
        
async function loadCLData() {
    const res = await authFetch(`${API}/cl`);
    if (!res.ok) {
        console.error("Failed loading CL data");
        return;
    }

    const data = await res.json();
    const tbody = document.getElementById("clTableBody");
    tbody.innerHTML = "";

    data.forEach((cl, index) => {
        const photo = cl.photo_url
            ? `<img src="${cl.photo_url}" class="default-photo">`
            : `<img src="https://icon-library.com/images/no-picture-available-icon/no-picture-available-icon-20.jpg" class="default-photo">`;

        tbody.innerHTML += `
            <tr>
                <td><input type="checkbox" class="clSelect" data-id="${cl.id}"></td>
                <td>${index + 1}</td>
                <td>${cl.name}</td>
                <td>${cl.gender}</td>
                <td>${cl.aadhar}</td>
                <td>${cl.phone}</td>
                <td>${cl.station}</td>
                <td>${cl.division}</td>
                <td>${cl.doj}</td>
                <td>${cl.dob}</td>
                <td>${cl.wages}</td>
                <td>${cl.nominee}</td>
                <td>${cl.relation}</td>
                <td>${photo}</td>
            </tr>
        `;
    });
}

function toggleSelectAll(el) {
    const checked = el.checked;
    document.querySelectorAll(".clSelect").forEach(ch => ch.checked = checked);
}

function getSelectedIds() {
    const ids = [];
    document.querySelectorAll(".clSelect:checked").forEach(ch => {
        ids.push(ch.getAttribute("data-id"));
    });
    return ids;
}

/* ============================================
      ESTIMATE MODULE ‚Äì FINAL VERSION
============================================ */


let estimateData = [];
let trashMode = false;
let estimatePage = 1;
let estimateRowsPerPage = 10;
let estSortField = null;
let estSortAsc = true;


/* ============================================
   1Ô∏è‚É£ ADD NEW ROW
============================================ */

function initEstimateEntryGrid() {
    estimateEntryBody.innerHTML = "";
    for (let i = 0; i < 10; i++) addEstimateRow();
}

function renderEstimateHeadings() {
    document.getElementById("estimateTableHead").innerHTML = `
        <th class="sortable" onclick="sortEstimate('sno')">S.No ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('description')">Description of Work ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('division')">Division ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('prNo')">PR No ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('estimateNo')">Estimate Sanction No ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('tspec')">T.Spec No ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('contractor')">Firm / Contractor ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('poNo')">PO No ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('grossAmount')">Gross Amount ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('netAmount')">Amount Excl. EPF/ESI/GST ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('loaNo')">LOA No ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('billingDoc')">SAP Billing Doc ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('mbookNo')">M-Book No ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('regPg')">Reg Pg No ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('backCharging')">Back Charging ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('dates')">Start + Completion Dates ‚Üï</th>
        <th class="sortable" onclick="sortEstimate('loa2')">LOA No 2 ‚Üï</th>
        <th>Actions</th>
    `;
}

        
function addEstimateRow(prefill = {}) {
    const tbody = document.getElementById("estimateEntryBody");

    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${tbody.rows.length + 1}</td>
        <td contenteditable data-col="description">${prefill.description || ""}</td>
        <td contenteditable data-col="division">${prefill.division || ""}</td>
        <td contenteditable data-col="prNo">${prefill.prNo || ""}</td>
        <td contenteditable data-col="estimateNo">${prefill.estimateNo || ""}</td>
        <td contenteditable data-col="tspec">${prefill.tspec || ""}</td>
        <td contenteditable data-col="contractor">${prefill.contractor || ""}</td>
        <td contenteditable data-col="poNo">${prefill.poNo || ""}</td>
        <td contenteditable data-col="grossAmount">${prefill.grossAmount || ""}</td>
        <td contenteditable data-col="netAmount">${prefill.netAmount || ""}</td>
        <td contenteditable data-col="loaNo">${prefill.loaNo || ""}</td>
        <td contenteditable data-col="billingDoc">${prefill.billingDoc || ""}</td>
        <td contenteditable data-col="mbookNo">${prefill.mbookNo || ""}</td>
        <td contenteditable data-col="regPg">${prefill.regPg || ""}</td>
        <td contenteditable data-col="backCharging">${prefill.backCharging || ""}</td>
        <td contenteditable data-col="dates">${prefill.dates || ""}</td>
        <td contenteditable data-col="loa2">${prefill.loa2 || ""}</td>

        <td>
            <button class="btn-add small save-row-btn" onclick="saveEstimateRow(this)">üíæ Save</button>
            <button class="btn-clear small" onclick="deleteEstimateEntryRow(this)">üóë</button>
        </td>
    `;
    tbody.appendChild(row);
}

/* Delete entry row (not database delete) */
function deleteEstimateEntryRow(btn) {
    btn.closest("tr").remove();
}

/* ============================================
   2Ô∏è‚É£ SAVE ROW TO SERVER
============================================ */
async function saveEstimateRow(btn) {
    const tr = btn.closest("tr");
    const fields = tr.querySelectorAll("[data-col]");

    const data = {};
    fields.forEach(td => data[td.dataset.col] = td.innerText.trim());

    await fetch(`${API}/estimates`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });

    showToast("Estimate saved");
    loadEstimateList();
}

/* ============================================
   3Ô∏è‚É£ LOAD ESTIMATE LIST FROM SERVER
============================================ */
async function loadEstimateList() {
    const url = trashMode
        ? `${API}/estimates/trash`
        : `${API}/estimates`;

    try {
        const res = await fetch(url);
        estimateData = await res.json();
        
        estimateData.sort((a, b) => a.id - b.id);
        
        renderEstimateList();
    } catch (e) {
        console.error("Load Estimates Failed:", e);
    }
}

        renderEstimateHeadings();

        function sortEstimate(field) {

    // special case : S.No sorting
    if (field === "sno") {

        // toggle ASC/DESC
        estSortAsc = !estSortAsc;

        // simply reverse the array
        estimateData.reverse();

        renderEstimateList();
        updateEstimateSortArrows();
        return;
    }

    // normal column sorting...
    if (estSortField === field) {
        estSortAsc = !estSortAsc;
    } else {
        estSortAsc = true;
        estSortField = field;
    }

    estimateData.sort((a, b) => {
        let A = a[field] ?? "";
        let B = b[field] ?? "";

        if (!isNaN(A) && !isNaN(B)) {
            A = parseFloat(A);
            B = parseFloat(B);
            return estSortAsc ? A - B : B - A;
        }

        return estSortAsc
            ? A.toString().localeCompare(B.toString())
            : B.toString().localeCompare(A.toString());
    });

    renderEstimateList();
    updateEstimateSortArrows();
}

function updateEstimateSortArrows() {
    const ths = document.querySelectorAll("#estimateTableHead th.sortable");

    ths.forEach(th => {
        const field = th.getAttribute("onclick").split("'")[1];

        if (field === estSortField || field === "sno") {
            th.innerHTML = th.innerHTML.replace(/‚Üï|‚Üë|‚Üì/g, "") +
                (estSortAsc ? " ‚Üë" : " ‚Üì");
        } else {
            th.innerHTML = th.innerHTML.replace(/‚Üï|‚Üë|‚Üì/g, "") + " ‚Üï";
        }
    });
}




/* ============================================
   4Ô∏è‚É£ RENDER ESTIMATE TABLE
============================================ */
function renderEstimateList() {
    const search = document.getElementById("estimateSearchInput").value.toLowerCase();
    const divFilter = document.getElementById("filterEstimateDivision").value;

    let filtered = estimateData.filter(r => {
        const matchText =
            (r.prNo || "").toLowerCase().includes(search) ||
            (r.division || "").toLowerCase().includes(search) ||
            (r.contractor || "").toLowerCase().includes(search) ||
            (r.description || "").toLowerCase().includes(search);

        const matchDiv = divFilter ? r.division === divFilter : true;

        return matchText && matchDiv;
    });

    // Same pagination + rendering...
 

    const start = (estimatePage - 1) * estimateRowsPerPage;
    const rows = filtered.slice(start, start + estimateRowsPerPage);

    document.getElementById("estimateListBody").innerHTML = rows.map((r, index) => `
        <tr>
            <td>${start + index + 1}</td>
            <td>${r.description || ""}</td>
            <td>${r.division || ""}</td>
            <td>${r.prNo || ""}</td>
            <td>${r.estimateNo || ""}</td>
            <td>${r.tspec || ""}</td>
            <td>${r.contractor || ""}</td>
            <td>${r.poNo || ""}</td>
            <td>${r.grossAmount || ""}</td>
            <td>${r.netAmount || ""}</td>
            <td>${r.loaNo || ""}</td>
            <td>${r.billingDoc || ""}</td>
            <td>${r.mbookNo || ""}</td>
            <td>${r.regPg || ""}</td>
            <td>${r.backCharging || ""}</td>
            <td>${r.dates || ""}</td>
            <td>${r.loa2 || ""}</td>

            <td>
                <button onclick='editEstimate(${JSON.stringify(r).replace(/"/g, '&quot;')})' class="small-btn edit-btn">‚úèÔ∏è Edit</button>
                <button onclick="trashEstimate(${r.id})" class="small-btn delete-btn">üóë Trash</button>
            </td>
        </tr>
    `).join("");

    updateEstimatePagination(filtered.length);
}

            
/* ============================================
   5Ô∏è‚É£ PAGINATION
============================================ */
function updateEstimatePagination(total) {
    const totalPages = Math.ceil(total / estimateRowsPerPage);
    document.getElementById("estimatePageInfo").innerText =
        `Page ${estimatePage} of ${totalPages}`;
}

function estimatePrevPage() {
    if (estimatePage > 1) estimatePage--;
    renderEstimateList();
}

function estimateNextPage() {
    const totalPages = Math.ceil(estimateData.length / estimateRowsPerPage);
    if (estimatePage < totalPages) estimatePage++;
    renderEstimateList();
}

/* ============================================
   6Ô∏è‚É£ EDIT EXISTING RECORD
============================================ */
function editEstimate(record) {
    addEstimateRow(record);
    window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ============================================
   7Ô∏è‚É£ MOVE TO TRASH
============================================ */
async function trashEstimate(id) {
    if (!confirm("Move to trash?")) return;

    await fetch(`${API}/estimates/${id}`, { method: "DELETE" });
    loadEstimateList();
}

function toggleEstimateTrash() {
    trashMode = !trashMode;

    document.getElementById("estimateTrashToggle").innerText =
        trashMode ? "üìÇ Back to Records" : "‚ôª View Trash";

    loadEstimateList();
}
function isEstimateRowEmpty(tr) {
    const tds = tr.querySelectorAll('td[contenteditable]');
    for (const td of tds) {
        if (td.textContent.trim() !== "") return false;
    }
    return true;
}

/* ============================================
   8Ô∏è‚É£ EXCEL IMPORT
============================================ */
async function importEstimateFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];

        // Convert Excel ‚Üí JSON rows
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        if (rows.length === 0) {
            showToast("Excel file is empty!", true);
            return;
        }

        // Clear previous rows
        estimateEntryBody.innerHTML = "";

        // Add rows from Excel
        rows.forEach(r => {
            addEstimateRow({
                description: r["Description of the Work"] || "",
                division: r["Division"] || "",
                prNo: r["PR No"] || "",
                estimateNo: r["Estimate Sanction No"] || "",
                tspec: r["T. Spec No"] || "",
                contractor: r["Firm / Contractor"] || "",
                poNo: r["PO No"] || "",
                grossAmount: r["Gross Amount"] || "",
                netAmount: r["Amount Excluding EPF/ESI/GST"] || "",
                loaNo: r["LOA No"] || "",
                billingDoc: r["SAP Billing Doc"] || "",
                mbookNo: r["M-Book No"] || "",
                regPg: r["Reg Pg No"] || "",
                backCharging: r["Back Charging"] || "",
                dates: r["Start + Completion Dates"] || "",
                loa2: r["LOA No 2"] || ""
            });
        });

        renumberEstimateRows();
        showToast(`Imported ${rows.length} estimate rows from Excel ‚úîÔ∏è`);

        // Auto-save all rows one by one (same as PR)
        await bulkSaveEstimateRows();

    } catch (err) {
        console.error(err);
        showToast("Estimate Excel Import Failed ‚ùå", true);
    }
}


async function bulkSaveEstimateRows() {
    const rows = [...estimateEntryBody.rows];

    for (let tr of rows) {
        const saveBtn = tr.querySelector(".save-row-btn");
        if (saveBtn) {
            await saveEstimateRow(saveBtn);
        }
    }

    showToast("All imported Estimate rows saved ‚úîÔ∏è");
    await loadEstimateList();
}
        
function renumberEstimateRows() {
    [...estimateEntryBody.rows].forEach((tr, i) => {
        tr.children[0].textContent = i + 1;
    });
}




        
async function loadEstimateDashboard() {
    const res = await fetch(`${API}/estimates`);
    const est = await res.json();

    if (!est || est.length === 0) return;

    let totalCount = est.length;
    let totalGross = 0;
    let totalNet = 0;

    est.forEach(e => {
        totalGross += parseFloat(e.grossAmount || 0);
        totalNet += parseFloat(e.netAmount || 0);
    });

    // Unique divisions
    const divisions = new Set(est.map(e => e.division).filter(x => x));

    // Update UI
    document.getElementById("estTotalCount").innerText = totalCount;
    document.getElementById("estTotalGross").innerText =
        "‚Çπ" + totalGross.toLocaleString("en-IN");
    document.getElementById("estTotalNet").innerText =
        "‚Çπ" + totalNet.toLocaleString("en-IN");
    document.getElementById("estDivisions").innerText = divisions.size;
}


        
/* ============================================
   INITIAL LOAD
============================================ */
loadEstimateList();

        
async function editSelected() {
    const ids = getSelectedIds();

    if (ids.length !== 1) {
        alert("Select exactly ONE record to edit.");
        return;
    }

    const id = ids[0];

    const res = await authFetch(`${API}/cl`);
    const data = await res.json();

    const cl = data.find(x => x.id == id);
    if (!cl) return alert("Record not found");

    document.getElementById("clId").value = cl.id;
    document.getElementById("clName").value = cl.name;
    document.getElementById("clGender").value = cl.gender;
    document.getElementById("clAadhar").value = cl.aadhar;
    document.getElementById("clPhone").value = cl.phone;
    document.getElementById("clStation").value = cl.station;
    document.getElementById("clDivision").value = cl.division;
    document.getElementById("clDoj").value = cl.doj;
    document.getElementById("clDob").value = cl.dob;
    document.getElementById("clWages").value = cl.wages;
    document.getElementById("clNominee").value = cl.nominee;
    document.getElementById("clRelation").value = cl.relation;

    window.scrollTo({ top: 0, behavior: "smooth" });
}


        
        /* ----------------- Toast Notifications ----------------- */
        function showToast(message, isError = false) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.classList.add(isError ? 'error' : 'success');
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        /* --- Custom Confirm Modal Logic --- */
        let onConfirmCallback = null;
        const confirmModal = document.getElementById('confirmModal');
        const confirmMsgEl = document.getElementById('confirmMessage');
        const confirmOkBtn = document.getElementById('confirmBtnOk');
        const confirmCancelBtn = document.getElementById('confirmBtnCancel'); // --- NEW ---

        function showConfirm(message, onConfirm, buttonClass = 'delete-btn') {
            confirmMsgEl.textContent = message;
            onConfirmCallback = onConfirm;
            
            confirmOkBtn.className = `small ${buttonClass}`;

            confirmModal.style.display = 'flex';
        }

        confirmOkBtn.onclick = () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            onConfirmCallback = null;
            confirmModal.style.display = 'none';
        };

        confirmCancelBtn.onclick = () => {
    confirmModal.style.display = 'none';
    onConfirmCallback = null; // RESET callback
};

function changeEstimateRowsPerPage() {
    const dropdown = document.getElementById("estimateShowEntries");

    estimateRowsPerPage = parseInt(dropdown.value);  // UPDATE THIS
    estimatePage = 1;                                // reset page

    renderEstimateList();                            // reload table
}



        /* =================================================================== */
        /* ===================== PDF DATABASE PANEL CODE ===================== */
        /* =================================================================== */
        const recordTable = document.getElementById('recordTable');
        const editId = document.getElementById('editId');
        let allRecords = [];
        let currentPage = 1;
        let recordsPerPage = 10;
        let filteredRecords = []; 
        let sortAsc = true;
    

        
        const filterSubDivisionEl = document.getElementById('filterSubDivision');
        const filterRecordTypeEl = document.getElementById('filterRecordType');
        const searchInputEl = document.getElementById('searchInput');

        let viewingTrash = false;

        async function loadRecords() {
            try {
                const res = await authFetch(`${API}/records`);
                if (!res.ok) throw new Error('Failed to load');
                
                allRecords = await res.json();
                
                populateFilterDropdowns(allRecords);
                applyAllFilters();
                
            } catch (err) {
                console.error(err);
                recordTable.innerHTML = "<tr><td colspan='8'>‚ö†Ô∏è Failed to load records</td></tr>";
            }
        }
        
        function populateFilterDropdowns(data) {
            const subDivisions = [...new Set(data.map(r => r.subDivision).filter(Boolean))];
            const recordTypes = [...new Set(data.map(r => r.recordType).filter(Boolean))];
            
            filterSubDivisionEl.innerHTML = '<option value="">All Sub Divisions</option>';
            subDivisions.sort().forEach(val => {
                filterSubDivisionEl.innerHTML += `<option value="${val}">${val}</option>`;
            });
            
            filterRecordTypeEl.innerHTML = '<option value="">All Record Types</option>';
            recordTypes.sort().forEach(val => {
                filterRecordTypeEl.innerHTML += `<option value="${val}">${val}</option>`;
            });
        }

        function updateDashboard(data = []) {
            const totalAmount = data.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
            const prCount = data.filter(r => (r.recordType || '').toLowerCase() === 'pr').length;
            const estimateCount = data.filter(r => (r.recordType || '').toLowerCase() === 'estimate').length;

            document.getElementById('pdfDashboard').innerHTML = `
                <div class="dash-box">
                    <h3>Total Records</h3>
                    <p id="statTotalRecords">${data.length}</p>
                </div>
                <div class="dash-box">
                    <h3>Total Amount</h3>
                    <p id="statTotalAmount">‚Çπ${totalAmount.toLocaleString('en-IN')}</p>
                </div>
                <div class="dash-box">
                    <h3>PRs</h3>
                    <p id="statPrCount">${prCount}</p>
                </div>
                <div class="dash-box">
                    <h3>Estimates</h3>
                    <p id="statEstimateCount">${estimateCount}</p>
                </div>
            `;
        }

// ======== PDF ENTRY GRID (FRONT-END EDITOR) ========
const pdfEntryBody = document.getElementById('pdfEntryBody');

async function importPRFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];

        // Convert sheet ‚Üí array of rows
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        if (rows.length === 0) {
            showToast("Excel file is empty!", true);
            return;
        }

        // Clear old PR grid and add rows based on Excel
        pdfEntryBody.innerHTML = "";

        rows.forEach((r, index) => {
            addPdfRow({
                prNo: r["PR No"] || "",
                date: r["Date"] || "",
                description: r["Procurement Description"] || "",
                amount: r["Amount"] || "",
                budgetHead: r["Budget Head"] || "",
                poNo: r["PO No"] || "",
                date2: r["Date 2"] || "",
                firmName: r["Name of the Firm"] || "",
                division: r["Division"] || "",
                pgNo: r["Page No"] || "",
                remarks: r["Remarks"] || "",
                highValue: r["High Value Spares"] || ""
            });
        });

        renumberPdfRows();
        showToast(`Imported ${rows.length} rows from Excel.`);

        // Auto-save each row after import
        await bulkSavePRRows();

    } catch (err) {
        console.error(err);
        showToast("Excel import failed", true);
    }
}
async function bulkSavePRRows() {
    const rows = [...pdfEntryBody.rows];

    for (let tr of rows) {
        const saveBtn = tr.querySelector(".save-row-btn");
        if (saveBtn) {
            await savePdfRow(saveBtn); // Calling your existing saveRecord logic
        }
    }

    showToast("All imported PR rows saved!");
    await loadRecords(); // Refresh main list
}


        
function rowIsEmpty(tr) {
    // check all editable cells except S.No & action/pdf columns
    const tds = tr.querySelectorAll('td[contenteditable="true"]');
    for (const td of tds) {
        if (td.textContent.trim() !== '') return false;
    }
    const fileInput = tr.querySelector('.pdf-file-input');
    if (fileInput && fileInput.files.length > 0) return false;
    return true;
}

function renumberPdfRows() {
    [...pdfEntryBody.rows].forEach((tr, idx) => {
        const snoCell = tr.querySelector('td[data-col="sno"]');
        if (snoCell) snoCell.textContent = idx + 1;
    });
}

function addPdfRow(prefill = {}) {
    const tr = document.createElement('tr');

    tr.innerHTML = `
        <td data-col="sno">${pdfEntryBody.rows.length + 1}</td>
        <td contenteditable="true" data-col="prNo">${prefill.prNo || ''}</td>
        <td contenteditable="true" data-col="date">${prefill.date || ''}</td>
        <td contenteditable="true" data-col="description">${prefill.description || ''}</td>
        <td contenteditable="true" data-col="amount">${prefill.amount || ''}</td>
        <td contenteditable="true" data-col="budgetHead">${prefill.budgetHead || ''}</td>
        <td contenteditable="true" data-col="poNo">${prefill.poNo || ''}</td>
        <td contenteditable="true" data-col="date2">${prefill.date2 || ''}</td>
        <td contenteditable="true" data-col="firmName">${prefill.firmName || ''}</td>
        <td contenteditable="true" data-col="division">${prefill.division || ''}</td>
        <td contenteditable="true" data-col="pgNo">${prefill.pgNo || ''}</td>
        <td contenteditable="true" data-col="remarks">${prefill.remarks || ''}</td>
        <td contenteditable="true" data-col="highValue">${prefill.highValue || ''}</td>
        <td data-col="pdf">
            <input type="file" class="pdf-file-input" accept="application/pdf">
        </td>
        <td data-col="actions">
            <button type="button" class="small-btn save-row-btn" onclick="savePdfRow(this)">Save Row</button>
            <button type="button" class="small-btn clear-row-btn" onclick="clearPdfRow(this)">Clear</button>
        </td>
    `;

    pdfEntryBody.appendChild(tr);
}

/** Make 10 starter rows on first load */
function initPdfEntryGrid() {
    pdfEntryBody.innerHTML = '';
    for (let i = 0; i < 10; i++) addPdfRow();
}

        
        function applyAllFilters() {
            const searchTerm = searchInputEl.value.toLowerCase();
            const subDiv = filterSubDivisionEl.value;
            const recType = filterRecordTypeEl.value;

            filteredRecords = allRecords.filter(r => {
                const matchesSearch = (
                    (r.workName || '').toLowerCase().includes(searchTerm) ||
                    (r.prNo || '').toLowerCase().includes(searchTerm) ||
                    (r.subDivision || '').toLowerCase().includes(searchTerm) ||
                    (r.recordType || '').toLowerCase().includes(searchTerm)
                );
                const matchesSubDiv = !subDiv || r.subDivision === subDiv;
                const matchesRecType = !recType || r.recordType === recType;
                
                return matchesSearch && matchesSubDiv && matchesRecType;
            });
            
            currentPage = 1;
            renderRecords(filteredRecords, viewingTrash);
            updateDashboard(filteredRecords);
        }

        function resetAllFilters() {
            searchInputEl.value = '';
            filterSubDivisionEl.value = '';
            filterRecordTypeEl.value = '';
            applyAllFilters();
        }
        
        searchInputEl.addEventListener('input', applyAllFilters);
        filterSubDivisionEl.addEventListener('change', applyAllFilters);
        filterRecordTypeEl.addEventListener('change', applyAllFilters);


        
function renderRecords(data, isTrash = false) {
  const tableHead = document.getElementById('pdfTableHead');
  const cardsContainer = document.getElementById('recordCards');

  // Build table header (desktop)
  if (isTrash) {
    tableHead.innerHTML = `
      <th class="wrap">Name</th>
      <th class="wrap">PR No</th>
      <th class="wrap">Sub Div</th>
      <th class="wrap">Deleted On</th>
      <th class="wrap">Actions</th>
    `;
  } else {
    tableHead.innerHTML = `
      <th class="wrap" onclick="sortRecords('id')">ID ‚ÜïÔ∏è</th>
      <th class="wrap" onclick="sortRecords('workName')">Name ‚ÜïÔ∏è</th>
      <th class="wrap" onclick="sortRecords('prNo')">PR No ‚ÜïÔ∏è</th>
      <th class="wrap" onclick="sortRecords('subDivision')">Sub Div ‚ÜïÔ∏è</th>
      <th class="wrap" onclick="sortRecords('recordType')">Type ‚ÜïÔ∏è</th>
      <th class="wrap" onclick="sortRecords('amount')">Amount ‚ÜïÔ∏è</th>
      <th class="wrap" onclick="sortRecords('sendTo')">Send To ‚ÜïÔ∏è</th>
      <th class="wrap">Actions</th>
    `;
  }

  const start = (currentPage - 1) * recordsPerPage;
  const end   = start + recordsPerPage;
  const paginated = data.slice(start, end);

  // Clear desktop table + mobile cards
  recordTable.innerHTML = '';
  if (cardsContainer) cardsContainer.innerHTML = '';

  if (!paginated.length) {
    const cols = isTrash ? 5 : 8;
    recordTable.innerHTML = `<tr><td colspan="${cols}">No records found</td></tr>`;
    if (cardsContainer) {
      const empty = document.createElement('div');
      empty.textContent = 'No records found';
      empty.style.fontSize = '0.9rem';
      cardsContainer.appendChild(empty);
    }
    document.getElementById('pageInfo').textContent = `Page 1 of 1`;
    return;
  }

  paginated.forEach(r => {
    /* ========= DESKTOP TABLE ROW ========= */
    const tr = document.createElement('tr');

    if (isTrash) {
      tr.innerHTML = `
        <td class="wrap">${r.workName || ''}</td>
        <td class="wrap">${r.prNo || ''}</td>
        <td class="wrap">${r.subDivision || ''}</td>
        <td class="wrap">${
          r.deletedOn ? new Date(r.deletedOn).toLocaleString() : ''
        }</td>
        <td class="wrap">
          <div class="actions">
            <button class="small-btn restore-btn" onclick="restoreRecord(${r.id})">Restore</button>
            <button class="small-btn delete-btn" onclick="deleteRecordPermanently(${r.id})">Delete Perm.</button>
          </div>
        </td>
      `;
    } else {
      tr.innerHTML = `
        <td class="wrap">${r.id || ''}</td>
        <td class="wrap">${r.workName || ''}</td>
        <td class="wrap">${r.prNo || ''}</td>
        <td class="wrap">${r.subDivision || ''}</td>
        <td class="wrap">${r.recordType || ''}</td>
        <td class="wrap">‚Çπ${r.amount ? parseFloat(r.amount).toLocaleString('en-IN') : '0'}</td>
        <td class="wrap">${r.sendTo || ''}</td>
        <td class="wrap">
          <div class="actions">
            ${r.pdfPath ? `<button class="small-btn preview-btn" onclick="previewPDF('${r.pdfPath}')">Preview</button>` : ''}
            <button class="small-btn edit-btn" onclick="editRecord(${r.id})">‚úèÔ∏è Edit</button>
            <button class="small-btn delete-btn" onclick="deleteRecord(${r.id})">üóë Trash</button>
            ${r.pdfPath ? `<button class="small-btn download-btn" onclick="downloadPDF('${r.pdfPath}')">Download</button>` : ''}
          </div>
        </td>
      `;
    }
    recordTable.appendChild(tr);

    /* ========= MOBILE CARD ========= */
    if (!cardsContainer) return;

    if (isTrash) {
      const card = document.createElement('div');
      card.className = 'record-card-trash';
      card.innerHTML = `
        <div class="record-card-trash-title">${r.workName || 'No name'}</div>
        <div class="record-card-trash-meta">
          <div><strong>PR No:</strong> ${r.prNo || '-'}</div>
          <div><strong>Sub Div:</strong> ${r.subDivision || '-'}</div>
          <div><strong>Deleted:</strong> ${
            r.deletedOn ? new Date(r.deletedOn).toLocaleString() : '-'
          }</div>
        </div>
        <div class="record-card-actions">
          <button class="small-btn restore-btn" onclick="restoreRecord(${r.id})">Restore</button>
          <button class="small-btn delete-btn" onclick="deleteRecordPermanently(${r.id})">Delete Permanently</button>
        </div>
      `;
      cardsContainer.appendChild(card);
    } else {
      const card = document.createElement('div');
      card.className = 'record-card';

      const amountText = r.amount
        ? `‚Çπ${parseFloat(r.amount).toLocaleString('en-IN')}`
        : '‚Çπ0';

      card.innerHTML = `
        <div class="record-card-header">
          <span class="record-name">${r.workName || 'No name'}</span>
          <span class="record-type">${r.recordType || ''}</span>
        </div>

        <div class="record-meta">
          <div class="record-meta-row">
            <span class="record-meta-label">ID:</span>
            <span>${r.id || '-'}</span>
          </div>
          <div class="record-meta-row">
            <span class="record-meta-label">PR No:</span>
            <span>${r.prNo || '-'}</span>
          </div>
          <div class="record-meta-row">
            <span class="record-meta-label">Sub Div:</span>
            <span>${r.subDivision || '-'}</span>
          </div>
          <div class="record-meta-row">
            <span class="record-meta-label">Amount:</span>
            <span>${amountText}</span>
          </div>
        </div>

        <div class="record-send-to">
          <span class="record-meta-label">Send To:</span>
          <span>${r.sendTo || '-'}</span>
        </div>

        <div class="record-card-actions">
          ${r.pdfPath ? `<button class="small-btn preview-btn" onclick="previewPDF('${r.pdfPath}')">Preview</button>` : ''}
          <button class="small-btn edit-btn" onclick="editRecord(${r.id})">Edit</button>
          <button class="small-btn delete-btn" onclick="deleteRecord(${r.id})">Trash</button>
          ${r.pdfPath ? `<button class="small-btn download-btn" onclick="downloadPDF('${r.pdfPath}')">Download</button>` : ''}
        </div>
      `;
      cardsContainer.appendChild(card);
    }
  });

  document.getElementById('pageInfo').textContent =
    `Page ${currentPage} of ${Math.max(1, Math.ceil(data.length / recordsPerPage))}`;
}

function changePdfRowsPerPage() {
    const dropdown = document.getElementById("pdfShowEntries");

    recordsPerPage = parseInt(dropdown.value);
    currentPage = 1;

    renderRecords(filteredRecords, viewingTrash);   // ‚úÖ Correct
}


        function nextPage() {
            if (currentPage < Math.ceil(filteredRecords.length / recordsPerPage)) {
                currentPage++;
                renderRecords(filteredRecords, viewingTrash);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderRecords(filteredRecords, viewingTrash);
            }
        }
        
        function sortRecords(field) {
            if (viewingTrash) return;
            const sorter = (a, b) => {
                let valA = a[field];
                let valB = b[field];
                if (field === 'amount' || field === 'id') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                }
                if (valA < valB) return sortAsc ? -1 : 1;
                if (valA > valB) return sortAsc ? 1 : -1;
                return 0;
            };
            allRecords.sort(sorter);
            filteredRecords.sort(sorter);
            sortAsc = !sortAsc;
            currentPage = 1;
            renderRecords(filteredRecords, viewingTrash);
        }
       const BACKEND = "https://nttps-backend.onrender.com";

async function savePdfRow(btn) {
    const tr = btn.closest('tr');
    if (!tr) return;

    const get = col => (tr.querySelector(`td[data-col="${col}"]`)?.textContent || '').trim();

    const prNo       = get('prNo');
    const description= get('description');
    const amount     = get('amount');
    const budgetHead = get('budgetHead');
    const poNo       = get('poNo');
    const date       = get('date');
    const date2      = get('date2');
    const firmName   = get('firmName');
    const division   = get('division');
    const pgNo       = get('pgNo');
    const remarks    = get('remarks');
    const highValue  = get('highValue');

    const fileInput = tr.querySelector('.pdf-file-input');
    const file = fileInput?.files[0] || null;

    const recordId = tr.dataset.recordId || '';
    const existingPdfPath = tr.dataset.pdfPath || '';

    if (!prNo) {
        showToast('PR No is required.', true);
        return;
    }
    if (!description) {
        showToast('Description is required.', true);
        return;
    }
    //if (!recordId && !file) {
        // new record must have a PDF
     //   showToast('Please choose a PDF file for this row.', true);
     //   return;
   // }

    const formData = new FormData();

    // PDF handling
    if (file) {
        formData.append('pdfs', file);       // backend already expects this
    } else if (recordId && existingPdfPath) {
        formData.append('pdfPath', existingPdfPath); // reuse old PDF
    }

    // existing fields used by your backend today
    formData.append('prNo', prNo);
    formData.append('workName', description);
    formData.append('amount', amount || '0');
    formData.append('subDivision', division || '');
    formData.append('recordType', 'PR');
    formData.append('sendTo', firmName || '');

    // üî¥ EXTRA COLUMNS ‚Äì require DB + server changes (see section 4)
    formData.append('prDate', date);
    formData.append('budgetHead', budgetHead);
    formData.append('poNo', poNo);
    formData.append('prDate2', date2);
    formData.append('firmName', firmName);
    formData.append('divisionLabel', division);
    formData.append('pageNo', pgNo);
    formData.append('remarks', remarks);
    formData.append('highValueSpares', highValue);

    if (recordId) {
        formData.append('id', recordId);
    }

    try {
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const res = await authFetch(`${API}/upload`, {
            method: 'POST',
            body: formData
        });

        const data = await res.json();

        if (!res.ok || (!data.success && !data.record)) {
            throw new Error(data.error || 'Save failed');
        }

        const saved = data.record || data.records?.[0];
        tr.dataset.recordId = saved.id;
        tr.dataset.pdfPath = saved.pdfPath || saved.pdf_url || '';

        showToast(recordId ? 'Row updated successfully.' : 'Row saved successfully.');

        // clear file input (keep the rest)
        if (fileInput) fileInput.value = '';

        // refresh the "All Records" list + dashboard
        await loadRecords();

    } catch (err) {
        console.error('savePdfRow error:', err);
        showToast(err.message || 'Server error', true);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Save Row';
    }
}
function clearPdfRow(btn) {
    const tr = btn.closest('tr');
    if (!tr) return;
    // if row is fully empty -> just clear file input and cells
    tr.querySelectorAll('td[contenteditable="true"]').forEach(td => td.textContent = '');
    const fileInput = tr.querySelector('.pdf-file-input');
    if (fileInput) fileInput.value = '';
    delete tr.dataset.recordId;
    delete tr.dataset.pdfPath;
}
document.getElementById("estimateSearchInput").addEventListener("input", () => {
    estimatePage = 1;
    renderEstimateList();
});

function clearPdfGrid() {
    showConfirm('Remove all completely empty rows and reset S.No?', () => {
        // remove rows that are fully empty
        [...pdfEntryBody.rows].forEach(tr => {
            if (rowIsEmpty(tr)) tr.remove();
        });
        // if none left, recreate 10
        if (pdfEntryBody.rows.length === 0) {
            initPdfEntryGrid();
        } else {
            renumberPdfRows();
        }
    }, 'btn-clear');
}

        
function previewPDF(path) {
    const iframe = document.getElementById("pdfFrame");
    iframe.src = path;
    document.getElementById("previewModal").style.display = "flex";
}

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
            document.getElementById('pdfFrame').src = '';
        }

        function editRecord(id) {
    const r = allRecords.find(rec => rec.id === id);
    if (!r) {
        showToast('Record not found.', true);
        return;
    }

    // find an empty row, or create a new one at bottom
    let targetRow = [...pdfEntryBody.rows].find(row => rowIsEmpty(row));
    if (!targetRow) {
        addPdfRow();
        targetRow = pdfEntryBody.rows[pdfEntryBody.rows.length - 1];
    }

    targetRow.dataset.recordId = r.id;
    targetRow.dataset.pdfPath  = r.pdfPath || '';

    const set = (col, val) => {
        const td = targetRow.querySelector(`td[data-col="${col}"]`);
        if (td) td.textContent = val || '';
    };

    set('prNo',       r.prNo || '');
    set('description',r.workName || '');
    set('amount',     r.amount || '');
    set('division',   r.subDivision || '');
    set('firmName',   r.sendTo || '');

    // if you already have these new columns in DB, fill them too:
    set('date',       r.prDate || '');
    set('budgetHead', r.budgetHead || '');
    set('poNo',       r.poNo || '');
    set('date2',      r.prDate2 || '');
    set('pgNo',       r.pageNo || '');
    set('remarks',    r.remarks || '');
    set('highValue',  r.highValueSpares || '');

    showToast('Loaded into PR grid. Edit row and click "Save Row".');
    
    // scroll to table
    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
}


        async function deleteRecord(id) {
            showConfirm('Move this record to the trash bin?', async () => {
                try {
                    const res = await authFetch(`${API}/records/${id}`, { method: 'DELETE' }); 
                    const data = await res.json();
                    if (data.success) {
                        showToast('Record moved to trash');
                        loadRecords();
                    } else showToast('Delete failed', true);
                } catch (err) {
                    console.error(err);
                    showToast('Server error', true);
                }
            });
        }
        
        async function toggleTrashView() {
            viewingTrash = !viewingTrash;
            const btn = document.getElementById('trashToggleBtn');
            const title = document.getElementById('pdfListTitle');
            
            if (viewingTrash) {
                btn.textContent = 'View Active Records';
                btn.style.backgroundColor = '#1D6F42';
                title.textContent = 'Trash Bin';
                await loadTrash();
            } else {
                btn.textContent = '‚ôªÔ∏è View Trash';
                btn.style.backgroundColor = '#dc3545';
                title.textContent = 'All Records';
                await loadRecords();
            }
            searchInputEl.disabled = viewingTrash;
            filterSubDivisionEl.disabled = viewingTrash;
            filterRecordTypeEl.disabled = viewingTrash;
        }

        async function loadTrash() {
            try {
                const res = await authFetch(`${API}/records/trash`);
                if (!res.ok) throw new Error('Failed to load trash');
                
                const trashRecords = await res.json();
                trashRecords.sort((a,b) => (b.deletedOn || '').localeCompare(a.deletedOn));
                
                allRecords = trashRecords;
                filteredRecords = trashRecords;
                currentPage = 1;
                
                renderRecords(filteredRecords, true);
                updateDashboard(filteredRecords);
                
            } catch (err) {
                showToast(err.message, true);
                recordTable.innerHTML = "<tr><td colspan='5'>‚ö†Ô∏è Failed to load trash</td></tr>";
            }
        }
        
        async function restoreRecord(id) {
            showConfirm('Restore this record to the main list?', async () => {
                try {
                    const res = await authFetch(`${API}/records/${id}/restore`, { method: 'POST' }); 
                    const data = await res.json();
                    if (data.success) {
                        showToast('Record restored');
                        loadTrash();
                    } else showToast('Restore failed', true);
                } catch (err) {
                    console.error(err);
                    showToast('Server error', true);
                }
            }, 'restore-btn');
        }

        async function deleteRecordPermanently(id) {
            showConfirm('PERMANENTLY DELETE this record? This cannot be undone.', async () => {
                try {
                    const res = await authFetch(`${API}/records/trash/${id}`, { method: 'DELETE' }); 
                    const data = await res.json();
                    if (data.success) {
                        showToast('Record permanently deleted');
                        loadTrash();
                    } else showToast('Delete failed', true);
                } catch (err) {
                    console.error(err);
                    showToast('Server error', true);
                }
            });
        }

        

        function downloadPDF(path) {
            const a = document.createElement('a');
            a.href = path.startsWith("http") ? path : BACKEND + path;
            a.download = path.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function goHome() { window.location.href = 'index.html'; }
        
        function logout() {
    // REMOVE EVERYTHING
    localStorage.removeItem("adminToken");
    localStorage.removeItem("isAdmin");
    localStorage.removeItem("savedEmail");
    localStorage.removeItem("rememberToken");
    localStorage.removeItem("savedToken");  // <-- IMPORTANT FIX

    // Prevent auto-login
    sessionStorage.setItem("loggedOut", "true");

    window.location.href = "login.html";
}




        async function autoExtractPDF() {
            const fileInput = document.getElementById("pdfFile");
            const file = fileInput.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append("pdfFile", file);
            try {
                const res = await authFetch(`${API}/extract-pdf`, { 
                    method: "POST", 
                    body: formData 
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || "Failed to extract PDF content");
                }

                const data = await res.json();
                if (data.workName) document.getElementById("workName").value = data.workName;
                if (data.prNo) document.getElementById("prNo").value = data.prNo;
                if (data.recordType) document.getElementById("recordType").value = data.recordType;
                if (data.amount) document.getElementById("amount").value = data.amount;

            } catch (err) {
                console.error(err);
                showToast(err.message, true);
            }
        }




        /* =================================================================== */
        /* =================== DAILY WORK PROGRESS PANEL CODE ================ */
        /* =================================================================== */
        const sheetTbody = document.getElementById('progressTableBody');
        const snapshotDateEl = document.getElementById('snapshotDate');
        const snapshotIdEl = document.getElementById('snapshotId');
        let loadedSnapshotDate = null; // <-- ADD THIS LINE
        

        
        function styleRow(tr) {
            if (!tr) return;
            const statusCell = tr.children[5];
            if (!statusCell) return;
            const status = statusCell.textContent.toLowerCase().trim();
            tr.classList.remove('status-done', 'status-progress', 'status-pending');
            if (status.includes('done') || status.includes('completed')) {
                tr.classList.add('status-done');
            } else if (status.includes('progress') || status.includes('wip')) {
                tr.classList.add('status-progress');
            } else if (status.includes('pending') || status.includes('issue')) {
                tr.classList.add('status-pending');
            }
        }
        function styleProgressRows() {
            sheetTbody.querySelectorAll('tr').forEach(styleRow);
        }
        sheetTbody.addEventListener('input', (e) => {
            const tr = e.target.closest('tr');
            styleRow(tr);
        });

        function addProgressRow(prefill={}) {
            const tr = document.createElement('tr');
            tr.draggable = true;
            
            const makeCell = (value='') => {
                const td = document.createElement('td');
                td.contentEditable = true;
                td.setAttribute('role','gridcell');
                td.textContent = value;
                return td;
            };
            tr.appendChild(makeCell(prefill.date || ''));
            tr.appendChild(makeCell(prefill.division || ''));
            tr.appendChild(makeCell(prefill.subDivision || ''));
            tr.appendChild(makeCell(prefill.activity || ''));
            tr.appendChild(makeCell(prefill.manpower || ''));
            tr.appendChild(makeCell(prefill.status || ''));
            tr.appendChild(makeCell(prefill.remarks || ''));
            const rowCell = document.createElement('td');
            tr.appendChild(rowCell);
            sheetTbody.appendChild(tr);
            styleRow(tr);
        }
        function insertRowBefore() {
            // 1. Create a new blank row (logic from addProgressRow)
            const tr = document.createElement('tr');
            tr.draggable = true; // Make it draggable

            const makeCell = (value='') => {
                const td = document.createElement('td');
                td.contentEditable = true;
                td.setAttribute('role','gridcell');
                td.textContent = value;
                return td;
            };
            
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            
            const rowCell = document.createElement('td');
            tr.appendChild(rowCell);

            // 2. Check if a row is selected
            if (!lastSelectedRow) {
                // If no row is selected, just add to the top
                sheetTbody.prepend(tr);
            } else {
                // If a row is selected, insert the new row *before* it
                lastSelectedRow.before(tr);
            }

            // 3. Update row numbers and style
            styleRow(tr);
            updateRowNumbers();
        }
        function insertRowAfter() {
            const tr = document.createElement('tr');
            tr.draggable = true;
            
            const makeCell = (value='') => {
                const td = document.createElement('td');
                td.contentEditable = true;
                td.setAttribute('role','gridcell');
                td.textContent = value;
                return td;
            };
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            tr.appendChild(makeCell(''));
            const rowCell = document.createElement('td');
            tr.appendChild(rowCell);
            if (!lastSelectedRow) {
                sheetTbody.appendChild(tr);
            } else {
                lastSelectedRow.after(tr);
            }
            styleRow(tr);
            updateRowNumbers();
        }

        function removeRow(btn){
            const tr = btn.closest('tr');
            if(tr) tr.remove();
            updateRowNumbers();
        }

        function clearSheet(){
            showConfirm('Clear all rows from the sheet?', () => {
                sheetTbody.innerHTML='';
                snapshotIdEl.value = '';
                loadedSnapshotDate = null;
                setDefaultDate();
                localStorage.removeItem('dailyProgressDraft');
                autoSaveMsgEl.textContent = '';
            });
        }

        function initSheet() {
            sheetTbody.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                addProgressRow();
            }
            updateRowNumbers(); 
            styleProgressRows();
        }
        
        function setDefaultDate() {
             if (!snapshotDateEl.value) {
                 snapshotDateEl.value = new Date().toISOString().substr(0, 10);
             }
         }

        function updateRowNumbers(){
            sheetTbody.querySelectorAll('tr').forEach((tr, idx)=>{
                const cell = tr.querySelector('td:last-child');
                if(cell) cell.innerHTML=`<button class="small small-btn delete-btn" style="padding: 4px 8px;" onclick="removeRow(this)">X</button> ${idx+1}`;
            });
        }
        
        async function saveProgress(){
¬† ¬† ¬† ¬† ¬† ¬† // --- FIX: Exclude selected row highlight from saved snapshot ---
let lastSelectedRowIndex = -1;
if (lastSelectedRow) {
    // Remember index and remove highlight temporarily
    lastSelectedRowIndex = Array.from(sheetTbody.children).indexOf(lastSelectedRow);
    lastSelectedRow.classList.remove('selected-row');
}

// Take clean HTML without highlight
const snapshotHTML = sheetTbody.innerHTML;

// Restore highlight back for user view
if (lastSelectedRowIndex > -1 && sheetTbody.children[lastSelectedRowIndex]) {
    sheetTbody.children[lastSelectedRowIndex].classList.add('selected-row');
}
// --- END FIX ---

unmergeCells();

¬† ¬† ¬† ¬† ¬† ¬† const rowCount = sheetTbody.querySelectorAll('tr').length;
¬† ¬† ¬† ¬† ¬† ¬† sheetTbody.innerHTML = snapshotHTML;
¬† ¬† ¬† ¬† ¬† ¬† updateRowNumbers();¬†
¬† ¬† ¬† ¬† ¬† ¬† styleProgressRows();

¬† ¬† ¬† ¬† ¬† ¬† const dateValue = snapshotDateEl.value; // This is 'YYYY-MM-DD'
¬† ¬† ¬† ¬† ¬† ¬† let snapshotId = snapshotIdEl.value; // <-- Use 'let' instead of 'const'

¬† ¬† ¬† ¬† ¬† ¬† if (!dateValue) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return showToast('Please select a date for this snapshot.', true);
¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† // --- NEW FORMATTING LOGIC ---
¬† ¬† ¬† ¬† ¬† ¬† const parts = dateValue.split('-'); // [YYYY, MM, DD]
¬† ¬† ¬† ¬† ¬† ¬† const formattedDate = `${parts[2]}/${parts[1]}/${parts[0]}`; // DD/MM/YYYY

            // --- THIS IS THE FIX ---
            // If we had a date loaded AND the new date is different,
            // we must clear the ID to force a "Save As New".
            if (loadedSnapshotDate && loadedSnapshotDate !== formattedDate) {
                snapshotId = null;
            }
            // --- END OF FIX ---

¬† ¬† ¬† ¬† ¬† ¬† if (!rowCount) return showToast('No rows to save.', true);
¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† try{
 const res = await authFetch(`${API}/daily-progress`, {
    method: 'POST',
    body: JSON.stringify({
        id: snapshotId || null,
        date: formattedDate,
        tableHTML: snapshotHTML,
        rowCount: rowCount
    })
});
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const data = await res.json();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(data.success){
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showToast(data.message);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† snapshotIdEl.value = '';
loadedSnapshotDate = null;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† localStorage.removeItem('dailyProgressDraft');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('autoSaveMsg').textContent = 'Snapshot saved!';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† loadSavedProgress();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showToast(`Save failed: ${data.error}`, true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† } catch(err){
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.error(err);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showToast('Server error', true);
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }

        async function loadSavedProgress(){
    try {
        const res = await authFetch(`${API}/daily-progress`);
        savedEntries = await res.json();

        // ‚úÖ Sort from newest ‚Üí oldest properly (handles DD/MM/YYYY format)
        savedEntries.sort((a, b) => {
            const parseDate = d => {
                if (!d) return 0;
                const parts = d.split(/[./-]/);
                return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
            };
            return parseDate(b.date) - parseDate(a.date);
        });

        savedFiltered = savedEntries.slice();
        savedPage = 1;
        renderSaved();
    } catch (err) {
        console.error(err);
        document.getElementById('savedBody').innerHTML = '<tr><td colspan="3">Failed to load saved progress</td></tr>';
    }
}


        function renderSaved(data=savedFiltered){
            const start=(savedPage-1)*savedPerPage;
            const end=start+savedPerPage;
            const pageItems=data.slice(start,end);
            const tbody=document.getElementById('savedBody');
            tbody.innerHTML='';

            if(!pageItems.length){
                tbody.innerHTML='<tr><td colspan="3">No saved snapshots</td></tr>';
                document.getElementById('savedPageInfo').textContent = `Page 1 of 1`;
                return;
            }

            pageItems.forEach(item=>{
                const tr=document.createElement('tr');
                tr.innerHTML= `
                    <td class="wrap"><strong>${item.date||''}</strong></td>
                    <td class="wrap">${item.rowCount||'0'} rows</td>
                    <td class="wrap">
                        <div class="actions">
                            <button class="small-btn preview-btn" onclick="previewSnapshot(${item.id})">Preview</button>
                            <button class="small-btn edit-btn" onclick="loadSnapshot(${item.id})">Load / Edit</button>
                            <button class="small-btn delete-btn" onclick="deleteSaved(${item.id})">Delete</button>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
            const totalPages=Math.max(1,Math.ceil(data.length/savedPerPage));
            document.getElementById('savedPageInfo').textContent=`Page ${savedPage} of ${totalPages}`;
        }
        
        async function loadSnapshot(id) {
¬† ¬† ¬† ¬† ¬† ¬† showConfirm('This will replace the current sheet. Are you sure?', async () => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† try {
¬† ¬† ¬† const res = await authFetch(`${API}/daily-progress/${id}`);

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!res.ok) throw new Error('Snapshot not found');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const snapshot = await res.json();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† sheetTbody.innerHTML = snapshot.tableHTML;

                    // --- THIS IS THE FIX ---
                    // snapshot.date is "DD.MM.YYYY" or "DD/MM/YYYY"
                    const parts = snapshot.date.split(/[./-]/); // Split by dot, slash, or dash
                    const inputDate = `${parts[2]}-${parts[1]}-${parts[0]}`; // YYYY-MM-DD
 snapshotDateEl.value = inputDate; // <-- Set the YYYY-MM-DD value
                    // --- END OF FIX ---

            snapshotIdEl.value = snapshot.id;
                    loadedSnapshotDate = snapshot.date; // <-- ADD THIS LINE

 updateRowNumbers();
 styleProgressRows();

 window.scrollTo(0, 0);
 } catch (err) {
 showToast(`Error loading snapshot: ${err.message}`, true);
 }
 }, 'edit-btn');
 }
        function nextSavedPage(){ if(savedPage<Math.ceil(savedFiltered.length/savedPerPage)){savedPage++; renderSaved();}}
        function prevSavedPage(){ if(savedPage>1){savedPage--; renderSaved();}}
        document.getElementById('savedSearch').addEventListener('input', e=>{
            const term=e.target.value.trim().toLowerCase();
            savedPage=1;
            if(!term){
                savedFiltered=savedEntries.slice();
                renderSaved();
                return;
            }
            savedFiltered=savedEntries.filter(item =>
                (item.date||'').toLowerCase().includes(term)
            );
            renderSaved();
        });

        function deleteSaved(id){
            showConfirm('Delete this saved snapshot? This cannot be undone.', () => {
                authFetch(`${API}/daily-progress/${id}`, { method: 'DELETE' })
                    .then(r=>r.json())
                    .then(data=>{
                        if(data.success) {
                            loadSavedProgress(); 
                            showToast('Snapshot deleted.');
                        }
                        else showToast('Delete failed', true);
                    })
                    .catch(err=>{console.error(err); showToast('Server error', true); });
            });
        }
        
        function handleSheetPaste(e) {
            const td = e.target.closest('td[contenteditable="true"]');
            if (!td) return;
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            const lines = text.split(/\r?\n/).filter(line => line.length > 0);
            if (lines.length <= 1) {
                td.textContent = text;
                return;
            }
            const cellIndex = td.cellIndex;
            const tr = td.parentElement;
            const rowIndex = Array.from(sheetTbody.children).indexOf(tr);
            const allRows = sheetTbody.querySelectorAll('tr');
            lines.forEach((line, i) => {
                const targetRowIndex = rowIndex + i;
                let targetRow = allRows[targetRowIndex];
                if (!targetRow) {
                    addProgressRow(); 
                    targetRow = sheetTbody.lastElementChild;
                }
                const targetCell = targetRow.children[cellIndex];
                if (targetCell) {
                    targetCell.textContent = line.trim();
                }
            });
            updateRowNumbers();
            styleProgressRows();
        }
        sheetTbody.addEventListener('paste', handleSheetPaste);

        function exportToExcel() {
            showConfirm("Export the current 'Daily Work Progress' table to an Excel file?", () => {
                const tableClone = document.getElementById('progressTable').cloneNode(true);
                tableClone.querySelector('thead tr').removeChild(tableClone.querySelector('thead tr').lastElementChild);
                tableClone.querySelectorAll('tbody tr').forEach(tr => {
                    if (tr.lastElementChild) {
                        tr.removeChild(tr.lastElementChild);
                    }
                });
                const wb = XLSX.utils.table_to_book(tableClone, { sheet: "Daily Progress" });
                let date = document.getElementById('snapshotDate').value || new Date().toISOString().substr(0, 10);
                const fileName = `DailyProgress_${date}.xlsx`;
                XLSX.writeFile(wb, fileName);
            }, 'btn-export');
        }
        
        async function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 1. Read the file
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = e.target.result;
                const wb = XLSX.read(data, { type: 'buffer' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                
                // 2. Convert to Array of Arrays to capture empty cells
                const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });

                if (aoa.length < 2) { // 1 row for header, 1 for data
                    showToast("Import failed: The sheet is empty.", true);
                    return;
                }

                // 3. Group all rows by their "Date" value
                const dateGroups = {};
                let currentDate = null; // This will "remember" the last date seen

                // Loop from row 1 (skipping the header row 0)
                for (let i = 1; i < aoa.length; i++) {
                    const row = aoa[i];
                    
                    let dateValue = row[0]; // Get the value from the 'Date' column (index 0)

                    // Check if this row has a new date
                    if (dateValue) {
                        let dateStr;
                        if (typeof dateValue === 'number') {
                            // It's an Excel serial date, convert it
                            const excelDate = new Date((dateValue - (25567 + 2)) * 86400 * 1000); // UTC
                            dateStr = excelDate.toISOString().substr(0, 10);
                        } else {
                            // It's a string, just trim it
                            dateStr = String(dateValue).trim();
                        }
                        currentDate = dateStr; // Set the new "current date"
                    }

                    if (!currentDate) {
                        continue; 
                    }

                    if (!dateGroups[currentDate]) {
                        dateGroups[currentDate] = [];
                    }

                    const rowObj = {
                        Date: currentDate,
                        Division: row[1] || '',
                        'Sub-Division/Location': row[2] || '',
                        'Maintenance Activity Description': row[3] || '',
                        'Man Power Engaged': row[4] || '',
                        Status: row[5] || '',
                        'Remarks/Issues': row[6] || ''
                    };
                    dateGroups[currentDate].push(rowObj);
                }

                // 4. Build the snapshot objects for the server
                const snapshotsToSave = [];
                for (const date in dateGroups) {
                    const rows = dateGroups[date];
                    let tableHTML = "";

                    for (const row of rows) {
                        tableHTML += `<tr>
                            <td contenteditable="true">${row.Date || ''}</td>
                            <td contenteditable="true">${row.Division || ''}</td>
                            <td contenteditable="true">${row['Sub-Division/Location'] || ''}</td>
                            <td contenteditable="true">${row['Maintenance Activity Description'] || ''}</td>
                            <td contenteditable="true">${row['Man Power Engaged'] || ''}</td>
                            <td contenteditable="true">${row.Status || ''}</td>
                            <td contenteditable="true">${row['Remarks/Issues'] || ''}</td>
                            <td></td>
                        </tr>`;
                    }

                    snapshotsToSave.push({
                        date: date,
                        tableHTML: tableHTML,
                        rowCount: rows.length
                    });
                }
                
                if (snapshotsToSave.length === 0) {
                    showToast("Import failed. No valid dates found in the 'Date' column.", true);
                    return;
                }

                // 5. Ask for confirmation
                const msg = `Found ${snapshotsToSave.length} unique date(s). This will add or update ${snapshotsToSave.length} snapshots in your archive. Continue?`;
                
                showConfirm(msg, async () => {
                    try {
                        const res = await authFetch(`${API}/daily-progress/batch-import`, {
                            method: 'POST',
                            body: JSON.stringify(snapshotsToSave)
                        });

                        const resultData = await res.json();
                        if (res.ok) {
                            showToast(resultData.message);
                            loadSavedProgress();
                        } else {
                            throw new Error(resultData.error || "Batch import failed");
                        }
                    } catch (err) {
                        console.error("Batch import error:", err);
                        showToast(err.message, true);
                    }
                }, 'btn-import-label');
            };
            
            reader.onerror = function() { showToast("There was an error reading the file.", true); };
            reader.readAsArrayBuffer(file);

            event.target.value = null;
        }


        let selectedCells = [];
        let lastSelectedRow = null; 
        sheetTbody.addEventListener('click', e => {
            const td = e.target.closest('td');
            if (!td) return; 
            const tr = td.parentElement;
            if (lastSelectedRow) {
                lastSelectedRow.classList.remove('selected-row');
            }
            tr.classList.add('selected-row');
            lastSelectedRow = tr;
            if (td === td.parentElement.lastElementChild) {
                 selectedCells.forEach(c => c.style.background = '');
                 selectedCells = [];
                 return;
            }
            if (e.shiftKey) {
                if (!selectedCells.includes(td)) {
                    td.style.background = 'lightblue';
                    selectedCells.push(td);
                } else {
                    td.style.background = '';
                    selectedCells.splice(selectedCells.indexOf(td), 1);
                }
            } else {
                selectedCells.forEach(c => c.style.background = '');
                selectedCells = [td];
                td.style.background = 'lightblue';
            }
        });
        function mergeCells() {
            if (selectedCells.length < 2) return showToast('Select 2+ cells with Shift+Click.', true);
            const rows = selectedCells.map(c => Array.from(sheetTbody.rows).indexOf(c.parentElement));
            const cols = selectedCells.map(c => Array.from(c.parentElement.children).indexOf(c));
            const minRow = Math.min(...rows), maxRow = Math.max(...rows);
            const minCol = Math.min(...cols), maxCol = Math.max(...cols);
            const topLeft = sheetTbody.rows[minRow].children[minCol];
            topLeft.setAttribute('rowspan', maxRow - minRow + 1);
            topLeft.setAttribute('colspan', maxCol - minCol + 1);
            for (const cell of selectedCells) {
                if (cell !== topLeft) cell.remove();
            }
            selectedCells.forEach(c => c.style.background = '');
            selectedCells = [];
            updateRowNumbers();
        }
        function unmergeCells() {
            sheetTbody.querySelectorAll('td[rowspan], td[colspan]').forEach(td => {
                const rowIndex = Array.from(sheetTbody.rows).indexOf(td.parentElement);
                const colIndex = Array.from(td.parentElement.children).indexOf(td);
                const rowspan = parseInt(td.getAttribute('rowspan') || 1);
                const colspan = parseInt(td.getAttribute('colspan') || 1);
                td.removeAttribute('rowspan');
                td.removeAttribute('colspan');
                for (let r = rowIndex; r < rowIndex + rowspan; r++) {
                    const targetRow = sheetTbody.rows[r];
                    for (let c = colIndex; c < colIndex + colspan; c++) {
                        if (r === rowIndex && c === colIndex) continue;
                        const newTd = document.createElement('td');
                        newTd.contentEditable = true;
                        newTd.setAttribute('role','gridcell');
                        if (c >= targetRow.children.length) {
                             targetRow.appendChild(newTd);
                        } else {
                             targetRow.insertBefore(newTd, targetRow.children[c]);
                        }
                    }
                }
            });
            updateRowNumbers();
        }

       async function previewSnapshot(id) {
            const modal = document.getElementById('snapshotPreviewModal');
            const contentEl = document.getElementById('snapshotFrame');
            
            contentEl.innerHTML = '<h4>Loading snapshot...</h4>';
            modal.style.display = 'flex';

            try {
                const res = await authFetch(`${API}/daily-progress/${id}`);
                if (!res.ok) throw new Error('Snapshot not found');
                
                const snapshot = await res.json();
                
                // Get the main table's headers HTML
                const theadHTML = document.querySelector('#progressTable thead').innerHTML;
                
                // Construct the full, "neat" table for preview
                contentEl.innerHTML = `
                    <h3>Daily progress on: ${snapshot.date}</h3>
                    <table id="previewTable">
                        <thead>${theadHTML}</thead>
                        <tbody>${snapshot.tableHTML}</tbody>
                    </table>
                `;
                
                
                // --- FIX 1: Remove "Row" column from header ---
                const previewTheadTR = contentEl.querySelector('#previewTable thead tr');
                if (previewTheadTR && previewTheadTR.lastElementChild) {
                    previewTheadTR.removeChild(previewTheadTR.lastElementChild); // Remove last <th> ("Row")
                }
                
                const previewTbodyTRs = contentEl.querySelectorAll('#previewTable tbody tr');
                
                // --- NEW LOGIC: Hide duplicate dates (but not on new groups) ---
                let previousDate = null;
                previewTbodyTRs.forEach(tr => {
                    const dateCell = tr.children[0];
                    const divisionCell = tr.children[1]; // Get the Division cell
                    
                    if (dateCell) {
                        const currentDate = dateCell.textContent;
                        
                        // Only clear the date if it's the same as the row above
                        // AND the division cell for this row is empty.
                        if (currentDate === previousDate && (divisionCell && divisionCell.textContent.trim() === '')) {
                            dateCell.textContent = ''; // Clear the text
                        } else if (currentDate.trim() !== '') {
                            // This is a new date, store it
                            previousDate = currentDate;
                        }
                    }
                    // --- End of New Logic ---
                    
                    // Remove last <td> (the row/button cell)
                    if (tr.lastElementChild) {
                        tr.removeChild(tr.lastElementChild);
                    }
                });

                // --- FIX 2: Remove 'contenteditable' from all preview cells ---
                contentEl.querySelectorAll('#previewTable td[contenteditable="true"]').forEach(cell => {
                    cell.removeAttribute('contenteditable');
                    cell.style.background = 'none'; // Also remove the yellow-ish edit background
                });

            } catch (err) {
                contentEl.innerHTML = `<h4>Error loading snapshot: ${err.message}</h4>`;
            }
        }
        function closeSnapshotPreview() {
            document.getElementById('snapshotPreviewModal').style.display = 'none';
            document.getElementById('snapshotFrame').innerHTML = '';
        }
        function printSnapshot() {
            const content = document.getElementById('snapshotFrame').innerHTML;
            const printWindow = window.open('', '', 'height=800,width=1000');
            printWindow.document.write('<html><head><title>Print Snapshot</title><style>body{font-family:Arial}h3{font-size:1.2rem}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid #000;padding:8px;text-align:left;white-space:normal;word-break:break-word}th{background:#eee}td button{display:none}</style></head><body>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }
        
        /* --- MODIFIED: Manual Save Draft Logic --- */
        const autoSaveMsgEl = document.getElementById('autoSaveMsg');

        function saveDraft() {
            const currentHTML = sheetTbody.innerHTML;
            localStorage.setItem('dailyProgressDraft', currentHTML);
            autoSaveMsgEl.textContent = `Draft saved at ${new Date().toLocaleTimeString()}`;
            showToast('Draft saved locally.');
        }
        
        function restoreDraft() {
            const savedDraft = localStorage.getItem('dailyProgressDraft');
            if (savedDraft) {
                showConfirm('An unsaved draft was found. Do you want to restore it?', () => {
                    sheetTbody.innerHTML = savedDraft;
                    updateRowNumbers();
                    styleProgressRows();
                    showToast('Draft restored.');
                }, 'restore-btn');
                
                // --- If they cancel, delete the draft ---
                const originalCancelClick = confirmCancelBtn.onclick;
                confirmCancelBtn.onclick = () => {
                    originalCancelClick(); // Run original logic
                    localStorage.removeItem('dailyProgressDraft');
                    showToast('Draft discarded.');
                };
            }
        }

function deleteSelected() {
    const ids = getSelectedIds();

    if (ids.length === 0) {
        alert("Select at least one record to delete.");
        return;
    }

    if (!confirm("Delete selected CL records?")) return;

    ids.forEach(id => {
        authFetch(`${API}/cl/${id}`, { method: "DELETE" })
            .then(() => loadCLData());
    });
}


        
 
        /* --- Drag-and-Drop Row Logic --- */
        let draggedRow = null;

        sheetTbody.addEventListener('dragstart', e => {
            if (e.target.tagName === 'BUTTON') {
                e.preventDefault();
                return;
            }
            const tr = e.target.closest('tr');
            if (tr) {
                draggedRow = tr;
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => tr.classList.add('dragging'), 0);
            }
        });

        sheetTbody.addEventListener('dragend', e => {
            if (draggedRow) {
                draggedRow.classList.remove('dragging');
            }
            draggedRow = null;
        });

        sheetTbody.addEventListener('dragover', e => {
            e.preventDefault();
        });

        sheetTbody.addEventListener('drop', e => {
            e.preventDefault();
            if (!draggedRow) return;

            draggedRow.classList.remove('dragging');
            const targetRow = e.target.closest('tr');

            if (targetRow && targetRow !== draggedRow) {
                const rect = targetRow.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                if (e.clientY < midY) {
                    targetRow.before(draggedRow);
                } else {
                    targetRow.after(draggedRow);
                }
            } else if (!targetRow) {
                sheetTbody.appendChild(draggedRow);
            }
            
            updateRowNumbers();
            draggedRow = null;
        });
function populateEstimateFilters() {
    const divisions = [...new Set(estimateData.map(r => r.division).filter(Boolean))].sort();

    const select = document.getElementById("filterEstimateDivision");
    select.innerHTML = `<option value="">All Divisions</option>` +
        divisions.map(d => `<option value="${d}">${d}</option>`).join("");
}

async function loadEstimateList() {
    const url = trashMode ? `${API}/estimates/trash` : `${API}/estimates`;
    const res = await fetch(url);
    estimateData = await res.json();

    estimateData.sort((a, b) => a.id - b.id);

    populateEstimateFilters();  // <-- IMPORTANT

    renderEstimateList();
}


        /* =================================================================== */
        /* ========================= INITIAL LOAD ========================== */
        /* =================================================================== */
        
        loadRecords();
        initPdfEntryGrid();
        initEstimateEntryGrid();
        initSheet();
        setDefaultDate(); 
        loadSavedProgress();
        restoreDraft();
        loadCLData();
        
    </script></body>

</html>






















































































