<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        const token = localStorage.getItem('adminToken');
        const isAdmin = localStorage.getItem('isAdmin');
        
        if (!token || isAdmin !== "true") {
  alert("You must be logged in to access this page.");
  window.location.href = "login.html";
}
    </script>
    <meta charset="UTF-8" />
    <title>Admin - PDF Database + Daily Progress</title>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    body { font-family: Arial; background:#f4f4f4; padding:20px; margin:0; }
    header { background:#232f3e; color:white; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:1.25rem; }
    header .buttons { display:flex; gap:10px; }
    header button { background:#dc3545; border:none; color:white; padding:8px 14px; border-radius:5px; cursor:pointer; font-weight:bold; }
    .btn-clear { background:#6c757d; color:white; }
        
    .btn-export { background: #1D6F42; color: white; }
    .btn-import-label { 
        background: #6f42c1;
        color: white; 
        cursor: pointer; 
        padding: 6px 10px; 
        border-radius: 6px; 
        font-size: 0.9rem;
        display: inline-block;
    }
    .container { 
        max-width: 1800px; 
        width: 95%;      
        margin: 20px auto; 
    }
    
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab-btn { padding:8px 14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; background:white; }
    .tab-btn.active { background:#007bff; color:white; border-color:#007bff; }
    .panel { background:white; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.06); display:none; }
    .panel.active { display:block; }
    
    label { display:block; margin-top:10px; font-weight:bold; }
    input, select, textarea { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box; }
    textarea { min-height:80px; resize:vertical; }
    .flex-row { display:flex; gap:12px; }
    .col { flex:1; }
    button.primary { margin-top:12px; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#28a745; color:white; }
    button.secondary { background:#007bff; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:15px; display:block; overflow:auto; max-height:420px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; vertical-align:top; }
    th { background:#f0f0f0; position:sticky; top:0; z-index:2; }
    th.wrap { cursor: pointer; } 
    tr:nth-child(even) { background:#fafafa; }
    
    td.wrap, th.wrap { white-space:normal; word-break:break-word; word-wrap:break-word; }
    
    .actions { 
        display:flex; 
        gap: 4px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .small-btn { 
        padding: 5px 7px;
        font-size: 0.8rem;
        border-radius:4px; border:none; cursor:pointer; font-weight:bold; 
        flex-shrink: 0;
    }
    
    .preview-btn { background:#ff9900; color:white; }
    .edit-btn { background:#007bff; color:white; }
    .delete-btn { background:#dc3545; color:white; }
    .download-btn { background:#28a745; color:white; }
    
    .restore-btn { background: #28a745; color:white; }
    
    th:last-child, td:last-child {
        min-width: 180px;
    }

    #messageBox { margin-top:10px; font-weight:bold; color:green; }
    
    .modal-overlay {
        display:none; 
        position:fixed; 
        top:0; left:0; 
        width:100%; height:100%; 
        background:rgba(0,0,0,0.6); 
        backdrop-filter:blur(4px); 
        justify-content:center; 
        align-items:center; 
        z-index:1000;
        animation: fadeIn 0.2s ease-out;
    }

    #previewModalContent { background:white; border-radius:10px; max-width:95%; width:1000px; height:90%; position:relative; padding:10px; display:flex; flex-direction:column; }
    #previewModalContent button.closeBtn { position:absolute; top:10px; right:10px; background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; z-index: 10; }
    #pdfFrame { flex:1; width:100%; border:none; border-radius:8px; }

    
    /* --- Modal Preview Fix --- */
    #snapshotPreviewContent { 
        background: white; 
        border-radius: 10px; 
        max-width: 95%; 
        width: 1200px; 
        max-height: 90%; 
        position: relative; 
        padding: 0;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    #snapshotPreviewContent .modal-controls { 
        display:flex; 
        gap:10px; 
        justify-content:flex-end; 
        border-bottom: 1px solid #ccc;
        padding: 20px 20px 10px 20px;
        background: white;
        z-index: 10;
        flex-shrink: 0;
    }
    #snapshotPreviewContent .modal-controls button { padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
    #snapshotPreviewContent .print-btn { background: #007bff; color: white; }
    #snapshotPreviewContent .closeBtn { background: #dc3545; color: white; }
    
    #snapshotFrame { 
        width: 100%;
        border: none; 
        margin: 0;
        padding: 10px 20px 20px 20px;
        box-sizing: border-box;
        background: #ffffff; 
        color: #000000;
        overflow: auto;
        flex-grow: 1;
    }
    
    #snapshotFrame table {
        width: auto;
        min-width: 100%;
        border-collapse: collapse;
        color: #000000;
    }
    /* --- End Modal Preview Fix --- */

    #snapshotFrame th, #snapshotFrame td { border:1px solid #ccc; padding:8px; text-align:left; vertical-align:top; white-space:normal; word-break:break-word; }
    #snapshotFrame th { background:#f0f0f0; position:static; }
    #snapshotFrame td button { display: none; } 
    #snapshotFrame td[contenteditable="true"] { background: none; }

    #progressTable, #savedProgressTable { width: 100%; border-collapse: collapse; margin-top: 10px; }
    #progressTable th, #progressTable td, #savedProgressTable th, #savedProgressTable td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; white-space: normal; min-width: 120px; }
    #progressTable td[contenteditable="true"] { background: #fffbe7; outline: none; min-height: 28px; }
    #progressTable th { background: #eaeaea; position: sticky; top: 0; }
    #savedProgressTable th { background: #f5f5f5; }
    .sheet-controls { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .small { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
    .btn-add { background:#28a745; color:white; }
    .btn-save { background:#007bff; color:white; }
    .btn-clear { background:#6c757d; color:white; }
    
    .search-row { display:flex; gap:8px; margin-top:10px; align-items:center; flex-wrap: wrap; }
    
    .muted { color:#666; font-size:0.9rem; }
/* --- NEW: Daily Progress Controls (Professional Look) --- */
.sheet-controls {
    display: flex;
    flex-wrap: wrap; /* Allows groups to stack on small screens */
    align-items: flex-end; /* Aligns all groups to the bottom */
    gap: 15px; /* Space between groups */
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
    border: 1px solid #eee;
    margin-bottom: 15px; /* Space before table */
}

/* Modern CL Records Table */
#clTableContainer {
    margin-top: 20px;
    padding: 15px;
    border-radius: 10px;
    background: #ffffff;
    box-shadow: 0px 2px 10px rgba(0,0,0,0.08);
    overflow-x: auto;
}

#clTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

#clTable thead th {
    background-color: #007bff !important;
    color: white !important;
    font-weight: bold;
    text-align: left;
}

#clTable th, #clTable td {
    padding: 10px 12px;
    border-bottom: 1px solid #e0e0e0;
}

#clTable tr:hover {
    background: #f5f8ff;
}

/* Checkbox column */
#clTable th:first-child, 
#clTable td:first-child {
    text-align: center;
    width: 40px;
}

/* S.No column */
#clTable td:nth-child(2) {
    width: 50px;
    font-weight: bold;
}

/* Buttons */
.edit-btn, .delete-btn {
    padding: 6px 12px;
    font-size: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    transition: 0.2s ease;
}

.edit-btn {
    background: #28a745;
}

.edit-btn:hover {
    background: #1e7e34;
}

.delete-btn {
    background: #dc3545;
}

.delete-btn:hover {
    background: #b52a36;
}

/* Top buttons */
#clActions {
    margin: 15px 0;
}

#clActions .top-btn {
    padding: 7px 14px;
    font-size: 14px;
    background: #0056d2;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 10px;
}

#clActions .top-btn:hover {
    background: #003e9c;
}

/* No photo image */
.default-photo {
    width: 45px;
    height: 45px;
    border-radius: 5px;
    object-fit: cover;
    border: 1px solid #ccc;
}


        
/* Style for each group of buttons */
.control-group {
    display: flex;
    align-items: center; /* Align items within the group */
    gap: 8px; /* Space between buttons in a group */
    
    /* Add a nice visual separator */
    padding-left: 15px;
    border-left: 1px solid #ccc;
}

/* Remove border from the first group */
.control-group:first-child {
    border-left: none;
    padding-left: 0;
}

/* Fix for the date label and input */
.control-group .date-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
/* Standardize labels in the control bar */
.control-group label {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600; 
}
/* Standardize inputs in the control bar */
.control-group input[type="date"] {
    width: 160px;
    padding: 6px 10px;
    margin: 0; /* Remove default margin */
}
/* --- End of New CSS --- */
    .selected-row > td {
        background-color: #dbeafe !important;
    }
    .pagination-btn {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
        transition: background-color 0.2s;
    }
    .pagination-btn:hover {
        background-color: #5a6268;
    }

    #toastContainer {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .toast {
        background: #232f3e;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        font-weight: bold;
        opacity: 0;
        transform: translateX(100%);
        animation: slideIn 0.3s forwards, slideOut 0.5s 3.5s forwards;
    }
    .toast.error { background: #dc3545; }
    .toast.success { background: #28a745; }
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(100%); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(100%); }
    }

    .pdf-dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    .dash-box {
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
    .dash-box h4 { margin: 0 0 5px 0; font-size: 0.9rem; color: #555; }
    .dash-box p { margin: 0; font-size: 1.5rem; font-weight: bold; color: #007bff; }
    .filter-bar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        background: #f9f9f9;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        align-items: center;
    }
    .filter-bar select {
        width: auto;
        flex: 1;
        min-width: 150px;
        padding: 8px;
    }
    .filter-bar .small {
        padding: 8px 12px;
    }

    tr.status-done > td { background-color: #e6ffed !important; }
    tr.status-progress > td { background-color: #fff9e0 !important; }
    tr.status-pending > td { background-color: #ffebe6 !important; }
    tr.selected-row > td { background-color: #dbeafe !important; }

    #formToggle {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 12px 18px;
        font-size: 1.25rem;
        color: #232f3e;
        cursor: pointer;
        display: block;
        width: 100%;
        text-align: left;
        margin-top: 10px;
        margin-bottom: 15px;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        box-sizing: border-box;
    }
    #formToggle:hover {
        background-color: #e9e9e9;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    #confirmModalContent {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        max-width: 400px;
        width: 90%;
        animation: fadeIn 0.2s ease-out;
    }
    #confirmTitle {
        margin: 0;
        color: #232f3e;
    }
    #confirmMessage {
        margin: 15px 0;
        color: #333;
        font-size: 1rem;
    }

    #progressTable tbody tr.dragging {
        opacity: 0.5;
        background: #f0f8ff;
        border: 1px dashed #007bff;
    }
    #progressTable tbody tr {
        transition: background-color 0.2s ease;
    }
    #progressTable tbody tr:hover {
        background-color: #f5f5f5;
        cursor: move;
    }


    @media (max-width: 650px) {
        header { flex-direction: column; gap: 12px; align-items: flex-start; }
        header .buttons { width: 100%; justify-content: flex-start; }
    }
    @media (max-width: 400px) {
         .tabs { flex-direction: column; align-items: stretch; }
         .tab-btn { text-align: center; }
    }
</style>
</head>
<body>
    <header>
        <h1>üìÇ Admin - PDF Database + Daily Progress</h1>
        <div class="buttons">
            <button onclick="goHome()">üè† Home</button>
            <button onclick="logout()">üö™ Logout</button>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button id="tabPdf" class="tab-btn active" onclick="showPanel('pdf')">PDF Database</button>
            <button id="tabDaily" class="tab-btn" onclick="showPanel('daily')">Daily Work Progress</button>
            <button id="tabCL" class="tab-btn" onclick="showPanel('cl')">CL Bio Data</button>
        </div>

        <div id="pdfPanel" class="panel active">
            
            <h2>üìä Dashboard</h2>
            <div id="pdfDashboard" class="pdf-dashboard-grid">
                </div>
            
            <hr style="margin:20px 0;">

            <div>
                <h2 id="formToggle">Add / Edit Record ‚ûï</h2>
                <div id="formWrapper" style="display: none; overflow: hidden; animation: fadeIn 0.3s ease-out;">
                    <h3>üìÑ PDF Database Editor</h3>

<div style="padding:10px 0;">
    <button id="addRowBtn" class="btn btn-success">‚ûï Add Row</button>
    <button id="savePDFBtn" class="btn btn-primary">üíæ Save All</button>
</div>

<table id="pdfTable" class="table table-bordered" style="width:100%; background:white;">
    <thead>
        <tr>
            <th>Name of Work</th>
            <th>PR No</th>
            <th>Sub Division</th>
            <th>Record Type</th>
            <th>PDF File</th>
            <th>Amount</th>
            <th>Send To</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="pdfTableBody">
    </tbody>
</table>

                </div>
            </div>
            
            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

            <div> <h2 id="pdfListTitle">All Records</h2>
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="üîç Search records..." style="padding:8px; border-radius:5px; border:1px solid #ccc; flex:1; min-width:150px;">
                    <select id="filterSubDivision" style="padding:8px;"></select>
                    <select id="filterRecordType" style="padding:8px;"></select>
                    <button class="small btn-clear" onclick="resetAllFilters()">Reset</button>
                    
                    <button id="trashToggleBtn" class="small btn-clear" onclick="toggleTrashView()" style="background-color: #dc3545;">‚ôªÔ∏è View Trash</button>
                </div>

                <div style="display:flex; justify-content:flex-end; flex-wrap:wrap; margin-bottom:10px;">
                    <div style="margin-top:5px;">
                        <button class="pagination-btn" onclick="prevPage()">‚¨Ö Prev</button>
                        <span id="pageInfo" style="margin:0 10px;">Page 1</span>
                        <button class="pagination-btn" onclick="nextPage()">Next ‚û°</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr id="pdfTableHead">
                            </tr>
                    </thead>
                    <tbody id="recordTable"></tbody>
                </table>
            </div>

        </div> 
        
        <div id="dailyPanel" class="panel">
            <h2>üßæ Daily Work Progress - Update/Edit</h2>
           <div class="sheet-controls">
            
            <div class="control-group">
                <div class="date-group">
                    <label for="snapshotDate">Progress Date:</label>
                    <input type="date" id="snapshotDate">
                </div>
            </div>

            <div class="control-group">
                <button class="small btn-add" onclick="addProgressRow()">‚ûï Add Row</button>
                <button class="small btn-add" onclick="insertRowBefore()">‚¨ÜÔ∏è Insert Row Before</button>
            <button class="small btn-add" onclick="insertRowAfter()">‚¨áÔ∏è Insert Row After</button>
            </div>
        
            <div class="control-group">
               <button id="dpSaveBtn" class="small btn-save">üíæ Save Progress</button>

<button id="dpDraftBtn" class="small btn-save" style="background-color: #ff9900;">
    üìù Save Draft
</button>

<button id="dpClearBtn" class="small btn-clear">üßπ Clear Sheet</button>



            </div>
            
            <div class="control-group">
                <button id="dpExportBtn" class="small btn-export">üì§ Export to Excel</button>
                <label for="importFile" class="btn-import-label">üì• Import from Excel</label>
                <input type="file" id="importFile" onchange="importFromExcel(event)" accept=".xlsx, .xls" style="display: none;">
            </div>
        
            <div class="control-group">
                <button class="small btn-merge" onclick="mergeCells()">üîÄ Merge Selected</button>
                <button class="small btn-unmerge" onclick="unmergeCells()">‚Ü©Ô∏è Unmerge</button>
            </div>
            
            <input type="hidden" id="snapshotId">
            
            <span id="autoSaveMsg" class="muted" style="margin-left: auto;"></span>
        </div>
            
            <div style="overflow:auto; border:1px solid #ddd; border-radius:6px;">
                <table id="progressTable" aria-label="Editable daily progress sheet">
                    <thead>
                        <tr>
                            <th style="width:100px">Date</th>
                            <th style="width:100px">Division</th>
                            <th style="width:140px">Sub-Division/Location</th>
                            <th style="min-width:300px">Maintenance Activity Description</th>
                            <th style="width:120px">Man Power Engaged</th>
                            <th style="width:120px">Status</th>
                            <th style="min-width:200px">Remarks/Issues</th>
                            <th style="width:80px">Row</th>
                        </tr>
                    </thead>
                    <tbody id="progressTableBody">
                    </tbody>
                </table>
            </div>

            <h3 style="margin-top:18px;">üìã Saved Daily Progress Reports (Archive)</h3>
            <div class="search-row">
                <input type="text" id="savedSearch" placeholder="üîç Search by date..." style="padding:8px; border-radius:5px; border:1px solid #ccc; flex:1;">
                <div>
                    <button class="small" onclick="prevSavedPage()">‚¨Ö Prev</button>
                    <span id="savedPageInfo" style="margin:0 8px">Page 1</span>
                    <button class="small" onclick="nextSavedPage()">Next ‚û°</button>
                </div>
            </div>
            <div style="overflow:auto; margin-top:8px; border:1px solid #eee; border-radius:6px;">
                <table id="savedProgressTable" aria-label="Saved daily progress snapshots">
                    <thead>
                        <tr>
                            <th style="width:400px">Snapshot Date</th>
                            <th style="width:400px">Row Count</th>
                            <th style="min-width:500px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="savedBody"></tbody>
                </table>
            </div>
        </div>
    </div> 
    
    <div id="previewModal" class="modal-overlay">
        <div id="previewModalContent">
            <button class="closeBtn" onclick="closePreview()">X</button>
            <iframe id="pdfFrame"></iframe>
        </div>
    </div>

    <div id="snapshotPreviewModal" class="modal-overlay">
        <div id="snapshotPreviewContent">
            <div class="modal-controls">
                <button class="print-btn" onclick="printSnapshot()">üñ®Ô∏è Print</button>
                <button class="closeBtn" onclick="closeSnapshotPreview()">X</button>
            </div>
            <div id="snapshotFrame">
            </div>
        </div>
    </div>

    <div id="clPanel" class="panel">
    <h2>üë∑ CL Bio Data Management</h2>

    <form id="clForm" enctype="multipart/form-data">
        <input type="hidden" id="clId">

        <label>Name</label>
        <input type="text" id="clName" required>

        <label>Gender</label>
        <select id="clGender">
            <option>Male</option>
            <option>Female</option>
        </select>

        <label>Aadhar</label>
        <input type="text" id="clAadhar">

        <label>Phone</label>
        <input type="text" id="clPhone">

        <label>Station</label>
        <input type="text" id="clStation">

        <label>Division</label>
        <input type="text" id="clDivision">

        <label>Date of Joining</label>
        <input type="text" id="clDoj">

        <label>Date of Birth</label>
        <input type="text" id="clDob">

        <label>Wages</label>
        <input type="text" id="clWages">

        <label>Nominee</label>
        <input type="text" id="clNominee">

        <label>Relation</label>
        <input type="text" id="clRelation">

        <label>Photo</label>
        <input type="file" id="clPhoto" accept="image/*">

        <button type="submit" class="primary">Save CL Data</button>
    </form>

    <hr>

    <h3>All CL Records</h3>

<div id="clActions">
    <button class="top-btn" onclick="editSelected()">Edit</button>
    <button class="top-btn" onclick="deleteSelected()">Delete</button>
</div>

<div id="clTableContainer">
    <table id="clTable">
        <thead>
            <tr>
                <th><input type="checkbox" onclick="toggleSelectAll(this)"></th>
                <th>S.No</th>
                <th>Name</th>
                <th>Gender</th>
                <th>Aadhar</th>
                <th>Phone</th>
                <th>Station</th>
                <th>Division</th>
                <th>Date of Joining</th>
                <th>Date of Birth</th>
                <th>Wages</th>
                <th>Nominee</th>
                <th>Relation</th>
                <th>Photo</th>
            </tr>
        </thead>
        <tbody id="clTableBody"></tbody>
    </table>
</div>

        <!-- ================= CONFIRM MODAL (REQUIRED) ================= -->
<div id="confirmModal" class="modal-overlay">
    <div id="confirmModalContent">
        <h3 id="confirmTitle">Confirm</h3>
        <p id="confirmMessage"></p>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button id="confirmBtnCancel" class="small btn-clear">Cancel</button>
            <button id="confirmBtnOk" class="small delete-btn">OK</button>
        </div>
    </div>
</div>
<!-- ================= END CONFIRM MODAL ================= -->


    <div id="toastContainer"></div>


    <script>
/*
  Clean, modular replacement script for add-product.html
  - Auth-safe fetch wrapper
  - PDF Database (list, filters, paging, trash/restore, preview, download)
  - PDF row editor (bulk rows in the "pdfTable" area)
  - Daily Progress editor (add/insert/delete/drag, save/load/export/import/preview)
  - CL Bio Data CRUD (upload via FormData)
  Defensive: checks for missing DOM elements before wiring listeners.
*/

(() => {
  const API = "https://nttps-backend.onrender.com"; // backend base
  const RECORDS_PER_PAGE = 10;
  const SAVED_PER_PAGE = 8;

  /* -------------------- Utilities -------------------- */
  function el(id) { return document.getElementById(id); }
  function qs(sel, root = document) { return root.querySelector(sel); }
  function qsa(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }
  function isFn(fn){ return typeof fn === 'function'; }

  // Toast
  function showToast(msg, isError = false) {
    const container = el('toastContainer') || (() => {
      const c = document.createElement('div'); c.id = 'toastContainer'; document.body.appendChild(c); return c;
    })();
    const d = document.createElement('div');
    d.className = 'toast ' + (isError ? 'error' : 'success');
    d.textContent = msg;
    container.appendChild(d);
    setTimeout(()=> d.remove(), 4000);
  }

  // Confirm modal wrapper (re-usable)
  let confirmCallback = null;
  function showConfirm(message, onConfirm, okClass='delete-btn') {
    const modal = el('confirmModal');
    if (!modal) { if (onConfirm) onConfirm(); return; }
    el('confirmMessage').textContent = message;
    confirmCallback = onConfirm;
    const okBtn = el('confirmBtnOk');
    okBtn.className = 'small ' + okClass;
    modal.style.display = 'flex';
  }
  function hideConfirm() { const m = el('confirmModal'); if(m) m.style.display='none'; confirmCallback = null; }
  if (el('confirmBtnOk')) el('confirmBtnOk').onclick = () => { if (confirmCallback) confirmCallback(); hideConfirm(); };
  if (el('confirmBtnCancel')) el('confirmBtnCancel').onclick = () => { hideConfirm(); };

  // Auth-aware fetch
  async function authFetch(url, opts = {}) {
    const token = localStorage.getItem('adminToken');
    const headers = new Headers(opts.headers || {});
    if (token) headers.set('Authorization', `Bearer ${token}`);
    // If not FormData and no Content-Type set, set JSON
    const isForm = opts.body instanceof FormData;
    if (!isForm && !headers.has('Content-Type')) headers.set('Content-Type', 'application/json');
    const res = await fetch(url, {...opts, headers});
    if (res.status === 401) {
      showToast('Session expired. Redirecting to login...', true);
      setTimeout(()=> { localStorage.removeItem('adminToken'); localStorage.removeItem('isAdmin'); window.location.href='login.html'; }, 1200);
    } else if (res.status === 403) {
      showToast('Forbidden (403) - check permissions', true);
    }
    return res;
  }

  /* -------------------- Generic safety guards -------------------- */
  function safeAddEvent(elm, ev, fn) { if(!elm) return; elm.addEventListener(ev, fn); }

  /* -------------------- PDF DATABASE: state & DOM -------------------- */
  let allRecords = [];
  let filteredRecords = [];
  let currentPage = 1;
  let viewingTrash = false;
  const pdfDashboardEl = el('pdfDashboard');
  const recordTableBody = el('recordTable');
  const pageInfoEl = el('pageInfo');
  const searchEl = el('searchInput');
  const filterSubEl = el('filterSubDivision');
  const filterTypeEl = el('filterRecordType');
  const pdfTableHead = el('pdfTableHead');

  async function loadRecords() {
    try {
      const res = await authFetch(`${API}/records`);
      if (!res.ok) throw new Error('Failed to load records');
      allRecords = await res.json();
      populateFilters();
      applyFilters();
    } catch (err) {
      console.error(err);
      if (recordTableBody) recordTableBody.innerHTML = `<tr><td colspan="8">‚ö†Ô∏è Failed to load records</td></tr>`;
      showToast('Failed to load records', true);
    }
  }

  function populateFilters() {
    if (!filterSubEl || !filterTypeEl) return;
    const subs = [...new Set(allRecords.map(x=>x.subDivision).filter(Boolean))].sort();
    const types = [...new Set(allRecords.map(x=>x.recordType).filter(Boolean))].sort();
    filterSubEl.innerHTML = '<option value="">All Sub Divisions</option>' + subs.map(s => `<option value="${s}">${s}</option>`).join('');
    filterTypeEl.innerHTML = '<option value="">All Record Types</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
  }

  function applyFilters() {
    const q = (searchEl && searchEl.value || '').toLowerCase();
    const sub = (filterSubEl && filterSubEl.value) || '';
    const type = (filterTypeEl && filterTypeEl.value) || '';
    filteredRecords = allRecords.filter(r => {
      const matchQ = !q || ['workName','prNo','subDivision','recordType'].some(k => (r[k] || '').toString().toLowerCase().includes(q));
      const matchSub = !sub || r.subDivision === sub;
      const matchType = !type || r.recordType === type;
      return matchQ && matchSub && matchType;
    });
    currentPage = 1;
    renderRecords();
    updateDashboard();
  }

  function updateDashboard() {
    if (!pdfDashboardEl) return;
    const data = filteredRecords || allRecords;
    const totalAmount = data.reduce((s, r) => s + (parseFloat(r.amount) || 0), 0);
    const prCount = data.filter(r => (r.recordType||'').toLowerCase()==='pr').length;
    const estCount = data.filter(r => (r.recordType||'').toLowerCase()==='estimate').length;
    pdfDashboardEl.innerHTML = `
      <div class="dash-box"><h4>Total Records</h4><p>${data.length}</p></div>
      <div class="dash-box"><h4>Total Amount</h4><p>‚Çπ${totalAmount.toLocaleString('en-IN')}</p></div>
      <div class="dash-box"><h4>PRs</h4><p>${prCount}</p></div>
      <div class="dash-box"><h4>Estimates</h4><p>${estCount}</p></div>
    `;
  }

  function renderRecords() {
    if (!recordTableBody) return;
    const isTrash = viewingTrash;
    // header
    if (pdfTableHead) {
      if (isTrash) {
        pdfTableHead.innerHTML = `<th class="wrap">Name</th><th class="wrap">PR No</th><th class="wrap">Sub Div</th><th class="wrap">Deleted On</th><th class="wrap">Actions</th>`;
      } else {
        pdfTableHead.innerHTML = `
          <th class="wrap" onclick="void(0)">ID</th>
          <th class="wrap">Name</th>
          <th class="wrap">PR No</th>
          <th class="wrap">Sub Div</th>
          <th class="wrap">Type</th>
          <th class="wrap">Amount</th>
          <th class="wrap">Send To</th>
          <th class="wrap">Actions</th>`;
      }
    }

    const start = (currentPage - 1) * RECORDS_PER_PAGE;
    const pageItems = (filteredRecords || []).slice(start, start + RECORDS_PER_PAGE);
    recordTableBody.innerHTML = '';
    if (!pageItems.length) {
      const cols = isTrash ? 5 : 8;
      recordTableBody.innerHTML = `<tr><td colspan="${cols}">No records found</td></tr>`;
      if (pageInfoEl) pageInfoEl.textContent = `Page 1 of 1`;
      return;
    }

    pageItems.forEach(r => {
      const tr = document.createElement('tr');
      if (isTrash) {
        tr.innerHTML = `
          <td class="wrap">${r.workName||''}</td>
          <td class="wrap">${r.prNo||''}</td>
          <td class="wrap">${r.subDivision||''}</td>
          <td class="wrap">${r.deletedOn ? new Date(r.deletedOn).toLocaleString() : ''}</td>
          <td class="wrap">
            <div class="actions">
              <button class="small-btn restore-btn">Restore</button>
              <button class="small-btn delete-btn">Delete Perm.</button>
            </div>
          </td>`;
        tr.querySelector('.restore-btn').addEventListener('click', ()=> restoreRecord(r.id));
        tr.querySelector('.delete-btn').addEventListener('click', ()=> deleteRecordPermanently(r.id));
      } else {
        tr.innerHTML = `
          <td class="wrap">${r.id || ''}</td>
          <td class="wrap">${r.workName || ''}</td>
          <td class="wrap">${r.prNo || ''}</td>
          <td class="wrap">${r.subDivision || ''}</td>
          <td class="wrap">${r.recordType || ''}</td>
          <td class="wrap">‚Çπ${r.amount ? parseFloat(r.amount).toLocaleString('en-IN') : '0'}</td>
          <td class="wrap">${r.sendTo || ''}</td>
          <td class="wrap">
            <div class="actions">
              ${r.pdfPath ? `<button class="small-btn preview-btn">Preview</button>` : ''}
              <button class="small-btn edit-btn">Edit</button>
              <button class="small-btn delete-btn">Trash</button>
              ${r.pdfPath ? `<button class="small-btn download-btn">Download</button>` : ''}
            </div>
          </td>`;
        if (r.pdfPath) tr.querySelector('.preview-btn').addEventListener('click', ()=> previewPDF(r.pdfPath));
        tr.querySelector('.edit-btn').addEventListener('click', ()=> openEditRecord(r));
        tr.querySelector('.delete-btn').addEventListener('click', ()=> deleteRecord(r.id));
        if (r.pdfPath) tr.querySelector('.download-btn').addEventListener('click', ()=> downloadPDF(r.pdfPath));
      }
      recordTableBody.appendChild(tr);
    });

    if (pageInfoEl) pageInfoEl.textContent = `Page ${currentPage} of ${Math.max(1, Math.ceil(filteredRecords.length / RECORDS_PER_PAGE))}`;
  }

  function nextPage() { if (currentPage < Math.ceil(filteredRecords.length / RECORDS_PER_PAGE)) { currentPage++; renderRecords(); } }
  function prevPage() { if (currentPage > 1) { currentPage--; renderRecords(); } }

  // Trash / restore / delete
  async function deleteRecord(id) {
    showConfirm('Move this record to trash?', async () => {
      try {
        const res = await authFetch(`${API}/records/${id}`, { method: 'DELETE' });
        const data = await res.json().catch(()=>({success:false}));
        if (data.success) { showToast('Moved to trash'); await loadRecords(); }
        else showToast('Delete failed', true);
      } catch (err) { console.error(err); showToast('Server error', true); }
    }, 'delete-btn');
  }
  async function loadTrash() {
    try {
      const res = await authFetch(`${API}/records/trash`);
      if (!res.ok) throw new Error('Failed to load trash');
      const trash = await res.json();
      allRecords = trash; filteredRecords = trash; currentPage = 1; viewingTrash = true;
      renderRecords();
      updateDashboard();
    } catch (err) { console.error(err); showToast('Failed to load trash', true); }
  }
  async function restoreRecord(id) {
    showConfirm('Restore record?', async () => {
      try {
        const res = await authFetch(`${API}/records/${id}/restore`, { method: 'POST' });
        const data = await res.json().catch(()=>({success:false}));
        if (data.success) { showToast('Restored'); await loadRecords(); } else showToast('Restore failed', true);
      } catch (err) { console.error(err); showToast('Server error', true); }
    }, 'restore-btn');
  }
  async function deleteRecordPermanently(id) {
    showConfirm('Permanently delete? This cannot be undone.', async () => {
      try {
        const res = await authFetch(`${API}/records/trash/${id}`, { method: 'DELETE' });
        const data = await res.json().catch(()=>({success:false}));
        if (data.success) { showToast('Deleted permanently'); await loadTrash(); } else showToast('Delete failed', true);
      } catch (err) { console.error(err); showToast('Server error', true); }
    }, 'delete-btn');
  }

  // Preview & download
  function previewPDF(path) {
    const iframe = el('pdfFrame');
    if (!iframe) { window.open(path, '_blank'); return; }
    iframe.src = path;
    const modal = el('previewModal'); if(modal) modal.style.display = 'flex';
  }
  function closePreview() { const m = el('previewModal'); if(m) { m.style.display='none'; const iframe = el('pdfFrame'); if(iframe) iframe.src=''; } }
  function downloadPDF(path) {
    const a = document.createElement('a');
    a.href = path.startsWith('http') ? path : API + path;
    a.download = path.split('/').pop();
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Edit record (if inline form exists, populate it; otherwise open drawer)
  function openEditRecord(record) {
    // Try to populate inputs if present
    const getOrNull = id => el(id) || null;
    const workName = getOrNull('workName');
    if (workName) {
      workName.value = record.workName || '';
      if (el('prNo')) el('prNo').value = record.prNo || '';
      if (el('subDivision')) el('subDivision').value = record.subDivision || '';
      if (el('recordType')) el('recordType').value = record.recordType || '';
      if (el('amount')) el('amount').value = record.amount || '';
      if (el('sendTo')) el('sendTo').value = record.sendTo || '';
      if (el('currentPdf')) el('currentPdf').value = record.pdfPath || '';
      if (el('editId')) el('editId').value = record.id || '';
      const wrapper = el('formWrapper'); if (wrapper) { wrapper.style.display='block'; el('formToggle').textContent='Add / Edit Record ‚ûñ'; }
      window.scrollTo({ top:0, behavior:'smooth' });
      return;
    }
    // fallback: open preview URL
    if (record.pdfPath) window.open(record.pdfPath, '_blank');
  }

  /* -------------------- PDF Table Bulk Rows (the Add Row -> Save All area) -------------------- */
  const pdfTableBody = el('pdfTableBody');
  function addPDFRow(data = {}) {
    if (!pdfTableBody) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="form-control" name="workName" value="${escapeHtml(data.workName||'')}" /></td>
      <td><input class="form-control" name="prNo" value="${escapeHtml(data.prNo||'')}" /></td>
      <td>
        <select class="form-control" name="subDivision">
          <option>Sub Div-I</option><option>Sub Div-II</option><option>Sub Div-III</option><option>Sub Div-IV</option>
        </select>
      </td>
      <td>
        <select class="form-control" name="recordType">
          <option>PR</option><option>Estimate</option><option>Drawing</option><option>Other Record</option>
        </select>
      </td>
      <td><input type="file" class="form-control" name="pdfFile" accept="application/pdf"/></td>
      <td><input class="form-control" name="amount" value="${escapeHtml(data.amount||'')}" /></td>
      <td><input class="form-control" name="sendTo" value="${escapeHtml(data.sendTo||'')}" /></td>
      <td><button class="btn btn-danger">‚ùå</button></td>
    `;
    tr.querySelector('button').addEventListener('click', ()=> tr.remove());
    pdfTableBody.appendChild(tr);
  }

  function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  async function saveAllPDFRows() {
    if (!pdfTableBody) return;
    const rows = qsa('tr', pdfTableBody);
    if (!rows.length) return showToast('No rows to save', true);
    showConfirm(`Save ${rows.length} record(s) to server?`, async () => {
      try {
        for (const r of rows) {
          const inputs = qsa('input, select', r);
          const form = new FormData();
          // inputs order: workName, prNo, subDivision(select), recordType(select), pdfFile, amount, sendTo
          const workName = inputs[0] && inputs[0].value || '';
          const prNo = inputs[1] && inputs[1].value || '';
          const subDiv = inputs[2] && inputs[2].value || '';
          const type = inputs[3] && inputs[3].value || '';
          const fileInput = r.querySelector('input[type="file"]');
          const amount = inputs[5] && inputs[5].value || '';
          const sendTo = inputs[6] && inputs[6].value || '';
          form.append('workName', workName);
          form.append('prNo', prNo);
          form.append('subDivision', subDiv);
          form.append('recordType', type);
          form.append('amount', amount);
          form.append('sendTo', sendTo);
          if (fileInput && fileInput.files[0]) form.append('pdfFile', fileInput.files[0]);
          // POST each row
          await authFetch(`${API}/records`, { method: 'POST', body: form });
        }
        showToast('All records saved');
        // Clear the added rows area
        pdfTableBody.innerHTML = '';
        await loadRecords();
      } catch (err) {
        console.error(err); showToast('Save failed', true);
      }
    }, 'btn-export');
  }

  /* -------------------- CL BIO DATA -------------------- */
  async function submitCLForm(e) {
    if (e && e.preventDefault) e.preventDefault();
    try {
      const form = el('clForm');
      if (!form) return;
      const fd = new FormData();
      ['clId','clName','clGender','clAadhar','clPhone','clStation','clDivision','clDoj','clDob','clWages','clNominee','clRelation']
        .forEach(id => { const elmt = el(id); if (elmt) fd.append(id.replace('cl','').toLowerCase(), elmt.value || ''); });

      // photo
      const photoEl = el('clPhoto');
      if (photoEl && photoEl.files && photoEl.files[0]) fd.append('photo', photoEl.files[0]);
      // If editing keep existing id
      if (el('clId') && el('clId').value) fd.append('id', el('clId').value);

      const res = await authFetch(`${API}/cl`, { method: 'POST', body: fd });
      const data = await res.json();
      if (data && data.success) {
        showToast('CL record saved');
        form.reset();
        loadCLData();
      } else {
        showToast(data && data.error ? data.error : 'Save failed', true);
      }
    } catch (err) { console.error(err); showToast('Server error', true); }
  }

  async function loadCLData() {
    try {
      const res = await authFetch(`${API}/cl`);
      if (!res.ok) throw new Error('Failed to load CL data');
      const data = await res.json();
      const tbody = el('clTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      data.forEach((cl, idx) => {
        const photo = cl.photo_url ? `<img src="${cl.photo_url}" class="default-photo">` : `<img src="https://icon-library.com/images/no-picture-available-icon/no-picture-available-icon-20.jpg" class="default-photo">`;
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td><input class="clSelect" type="checkbox" data-id="${cl.id}"></td>
            <td>${idx+1}</td>
            <td>${escapeHtml(cl.name||'')}</td>
            <td>${escapeHtml(cl.gender||'')}</td>
            <td>${escapeHtml(cl.aadhar||'')}</td>
            <td>${escapeHtml(cl.phone||'')}</td>
            <td>${escapeHtml(cl.station||'')}</td>
            <td>${escapeHtml(cl.division||'')}</td>
            <td>${escapeHtml(cl.doj||'')}</td>
            <td>${escapeHtml(cl.dob||'')}</td>
            <td>${escapeHtml(cl.wages||'')}</td>
            <td>${escapeHtml(cl.nominee||'')}</td>
            <td>${escapeHtml(cl.relation||'')}</td>
            <td>${photo}</td>
          </tr>
        `);
      });
    } catch (err) { console.error(err); showToast('Failed to load CL data', true); }
  }

  function getSelectedCLIds() {
    return qsa('.clSelect:checked').map(ch => ch.dataset.id);
  }

  async function deleteSelectedCL() {
    const ids = getSelectedCLIds();
    if (!ids.length) return alert('Select at least one record');
    if (!confirm('Delete selected CL records?')) return;
    try {
      for (const id of ids) await authFetch(`${API}/cl/${id}`, { method: 'DELETE' });
      showToast('Deleted selected records');
      loadCLData();
    } catch (err) { console.error(err); showToast('Delete failed', true); }
  }

  async function editSelectedCL() {
    const ids = getSelectedCLIds();
    if (ids.length !== 1) return alert('Select exactly ONE record to edit.');
    try {
      const res = await authFetch(`${API}/cl`);
      const list = await res.json();
      const cl = list.find(x => x.id == ids[0]);
      if (!cl) return alert('Record not found');
      // populate form
      ['Name','Gender','Aadhar','Phone','Station','Division','Doj','Dob','Wages','Nominee','Relation'].forEach(k => {
        const id = 'cl' + k.toLowerCase();
        if (el(id)) el(id).value = cl[k.toLowerCase()] || cl[k] || '';
      });
      if (el('clId')) el('clId').value = cl.id;
      window.scrollTo({ top:0, behavior:'smooth' });
    } catch (err) { console.error(err); showToast('Failed to load record', true); }
  }

  /* -------------------- Daily Progress sheet features -------------------- */
  const sheetTbody = el('progressTableBody');
  const snapshotDateEl = el('snapshotDate');
  const snapshotIdEl = el('snapshotId');
  const autoSaveMsgEl = el('autoSaveMsg');
  let lastSelectedRow = null;
  let loadedSnapshotDate = null;

  function initSheet(defaultRows = 20) {
    if (!sheetTbody) return;
    sheetTbody.innerHTML = '';
    for (let i=0;i<defaultRows;i++) addProgressRow();
    updateRowNumbers();
  }

  function addProgressRow(prefill = {}) {
    if (!sheetTbody) return;
    const tr = document.createElement('tr'); tr.draggable = true;
    const makeCell = (txt='') => { const td = document.createElement('td'); td.contentEditable = true; td.setAttribute('role','gridcell'); td.textContent = txt; return td; };
    tr.appendChild(makeCell(prefill.date||''));
    tr.appendChild(makeCell(prefill.division||''));
    tr.appendChild(makeCell(prefill.subDivision||''));
    tr.appendChild(makeCell(prefill.activity||''));
    tr.appendChild(makeCell(prefill.manpower||''));
    tr.appendChild(makeCell(prefill.status||''));
    tr.appendChild(makeCell(prefill.remarks||''));
    const last = document.createElement('td'); last.innerHTML = `<button class="small small-btn delete-btn" style="padding:4px 8px">X</button> 0`;
    last.querySelector('button').addEventListener('click', (e)=> { const tr = e.target.closest('tr'); if (tr) tr.remove(); updateRowNumbers(); });
    tr.appendChild(last);
    sheetTbody.appendChild(tr);
    styleRow(tr);
  }

  function updateRowNumbers() {
    if (!sheetTbody) return;
    Array.from(sheetTbody.children).forEach((tr, idx) => {
      const last = tr.querySelector('td:last-child');
      if (last) last.innerHTML = `<button class="small small-btn delete-btn" style="padding:4px 8px" onclick="this.closest('tr').remove();undefined">${idx+1}</button> ${idx+1}`;
    });
  }

  function styleRow(tr) {
    if (!tr) return;
    const statusCell = tr.children[5];
    if (!statusCell) return;
    const status = (statusCell.textContent||'').toLowerCase();
    tr.classList.remove('status-done','status-progress','status-pending','selected-row');
    if (status.includes('done') || status.includes('completed')) tr.classList.add('status-done');
    else if (status.includes('progress') || status.includes('wip')) tr.classList.add('status-progress');
    else if (status.includes('pending') || status.includes('issue')) tr.classList.add('status-pending');
  }

  function styleProgressRows(){ if(!sheetTbody) return; qsa('tr', sheetTbody).forEach(styleRow); }

  // click selection & multi-cell selection
  if (sheetTbody) {
    sheetTbody.addEventListener('click', (e) => {
      const td = e.target.closest('td');
      if (!td) return;
      const tr = td.parentElement;
      if (lastSelectedRow) lastSelectedRow.classList.remove('selected-row');
      tr.classList.add('selected-row');
      lastSelectedRow = tr;
      updateRowNumbers();
    });
    sheetTbody.addEventListener('input', (e) => {
      const tr = e.target.closest('tr'); styleRow(tr);
    });
  }

  // Drag & drop rows
  let dragged = null;
  if (sheetTbody) {
    sheetTbody.addEventListener('dragstart', (e) => {
      const tr = e.target.closest('tr'); if (!tr) return;
      dragged = tr; setTimeout(()=> tr.classList.add('dragging'), 0);
    });
    sheetTbody.addEventListener('dragend', (e) => { if (dragged) dragged.classList.remove('dragging'); dragged = null; });
    sheetTbody.addEventListener('dragover', (e)=> e.preventDefault());
    sheetTbody.addEventListener('drop', (e) => {
      e.preventDefault();
      if (!dragged) return;
      const target = e.target.closest('tr');
      if (target && target !== dragged) {
        const rect = target.getBoundingClientRect(), midY = rect.top + rect.height/2;
        if (e.clientY < midY) target.before(dragged); else target.after(dragged);
      } else if (!target) sheetTbody.appendChild(dragged);
      updateRowNumbers();
      dragged = null;
    });
  }

  // Save progress snapshot
  async function saveProgress() {
    if (!sheetTbody) return;
    const rows = qsa('tr', sheetTbody);
    if (!rows.length) return showToast('No rows to save', true);
    const dateVal = snapshotDateEl && snapshotDateEl.value;
    if (!dateVal) return showToast('Select a date', true);
    // format to DD/MM/YYYY for server (your server expects that)
    const parts = dateVal.split('-'); const formatted = `${parts[2]}/${parts[1]}/${parts[0]}`;
    // If loaded snapshot had a different date we must clear id to 'save as new'
    let idToSend = snapshotIdEl && snapshotIdEl.value || null;
    if (loadedSnapshotDate && loadedSnapshotDate !== formatted) idToSend = null;

    // gather table HTML (do not include the last 'Row' buttons column when saving preview)
    const tableClone = sheetTbody.cloneNode(true);
    // remove the last column content (buttons) in each row
    qsa('tr', tableClone).forEach(tr => { if (tr.lastElementChild) tr.removeChild(tr.lastElementChild); });
    const tableHTML = tableClone.innerHTML;

    try {
      const res = await authFetch(`${API}/daily-progress`, {
        method: 'POST',
        body: JSON.stringify({ id: idToSend || null, date: formatted, tableHTML, rowCount: rows.length })
      });
      const data = await res.json().catch(()=>({success:false}));
      if (data.success) {
        showToast(data.message || 'Snapshot saved');
        if (snapshotIdEl) snapshotIdEl.value = '';
        loadedSnapshotDate = null;
        localStorage.removeItem('dailyProgressDraft');
        if (autoSaveMsgEl) autoSaveMsgEl.textContent = 'Snapshot saved!';
        await loadSavedProgress();
      } else showToast(data.error || 'Save failed', true);
    } catch (err) { console.error(err); showToast('Server error', true); }
  }

  // Load saved progress list
  let savedEntries = [], savedFiltered = [], savedPage = 1;
  async function loadSavedProgress() {
    try {
      const res = await authFetch(`${API}/daily-progress`);
      if (!res.ok) throw new Error('Failed to load saved snapshots');
      savedEntries = await res.json();
      // sort by DD/MM/YYYY -> newest first
      savedEntries.sort((a,b) => {
        const parseDate = d => { if(!d) return 0; const p = d.split(/[./-]/); return new Date(p[2], p[1]-1, p[0]).getTime(); };
        return parseDate(b.date) - parseDate(a.date);
      });
      savedFiltered = savedEntries.slice();
      savedPage = 1;
      renderSaved();
    } catch (err) { console.error(err); if (el('savedBody')) el('savedBody').innerHTML = '<tr><td colspan="3">Failed to load saved progress</td></tr>'; }
  }

  function renderSaved() {
    const tbody = el('savedBody'); if (!tbody) return;
    const start = (savedPage-1) * SAVED_PER_PAGE; const end = start + SAVED_PER_PAGE;
    const pageItems = savedFiltered.slice(start, end);
    tbody.innerHTML = '';
    if (!pageItems.length) { tbody.innerHTML = '<tr><td colspan="3">No saved snapshots</td></tr>'; if (el('savedPageInfo')) el('savedPageInfo').textContent = `Page 1 of 1`; return; }
    pageItems.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="wrap"><strong>${item.date||''}</strong></td>
        <td class="wrap">${item.rowCount||0} rows</td>
        <td class="wrap">
          <div class="actions">
            <button class="small-btn preview-btn">Preview</button>
            <button class="small-btn edit-btn">Load / Edit</button>
            <button class="small-btn delete-btn">Delete</button>
          </div>
        </td>`;
      tr.querySelector('.preview-btn').addEventListener('click', ()=> previewSnapshot(item.id));
      tr.querySelector('.edit-btn').addEventListener('click', ()=> loadSnapshot(item.id));
      tr.querySelector('.delete-btn').addEventListener('click', ()=> deleteSaved(item.id));
      tbody.appendChild(tr);
    });
    const totalPages = Math.max(1, Math.ceil(savedFiltered.length / SAVED_PER_PAGE));
    if (el('savedPageInfo')) el('savedPageInfo').textContent = `Page ${savedPage} of ${totalPages}`;
  }

  async function loadSnapshot(id) {
    showConfirm('This will replace the current sheet. Continue?', async () => {
      try {
        const res = await authFetch(`${API}/daily-progress/${id}`);
        if (!res.ok) throw new Error('Snapshot not found');
        const snapshot = await res.json();
        // snapshot.date = DD/MM/YYYY or similar; convert to YYYY-MM-DD for input
        const parts = snapshot.date.split(/[./-]/);
        const inputDate = `${parts[2]}-${parts[1]}-${parts[0]}`; if (snapshotDateEl) snapshotDateEl.value = inputDate;
        if (sheetTbody) sheetTbody.innerHTML = snapshot.tableHTML;
        if (snapshotIdEl) snapshotIdEl.value = snapshot.id;
        loadedSnapshotDate = snapshot.date;
        updateRowNumbers(); styleProgressRows();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) { console.error(err); showToast(`Error loading snapshot: ${err.message}`, true); }
    }, 'edit-btn');
  }

  async function previewSnapshot(id) {
    const modal = el('snapshotPreviewModal'), frame = el('snapshotFrame');
    if (!frame) return;
    frame.innerHTML = '<h4>Loading snapshot...</h4>'; if (modal) modal.style.display = 'flex';
    try {
      const res = await authFetch(`${API}/daily-progress/${id}`);
      if (!res.ok) throw new Error('Snapshot not found');
      const snapshot = await res.json();
      const theadHTML = el('progressTable') ? el('progressTable').querySelector('thead').innerHTML : '';
      frame.innerHTML = `<h3>Daily progress on: ${snapshot.date}</h3><table id="previewTable"><thead>${theadHTML}</thead><tbody>${snapshot.tableHTML}</tbody></table>`;
      // Remove last column in preview
      const previewTR = frame.querySelector('#previewTable thead tr');
      if (previewTR && previewTR.lastElementChild) previewTR.removeChild(previewTR.lastElementChild);
      qsa('#previewTable tbody tr', frame).forEach(tr => { if (tr.lastElementChild) tr.removeChild(tr.lastElementChild); });
      // remove contenteditable on preview
      qsa('#previewTable td[contenteditable="true"]', frame).forEach(td => { td.removeAttribute('contenteditable'); td.style.background='none'; });
    } catch (err) { console.error(err); frame.innerHTML = `<h4>Error loading snapshot: ${err.message}</h4>`; }
  }
  function closeSnapshotPreview(){ const m = el('snapshotPreviewModal'); if (m) { m.style.display='none'; el('snapshotFrame').innerHTML=''; } }

  async function deleteSaved(id) {
    showConfirm('Delete this saved snapshot? This cannot be undone.', async () => {
      try {
        const res = await authFetch(`${API}/daily-progress/${id}`, { method: 'DELETE' });
        const data = await res.json().catch(()=>({success:false}));
        if (data.success) { showToast('Snapshot deleted'); await loadSavedProgress(); } else showToast('Delete failed', true);
      } catch (err) { console.error(err); showToast('Server error', true); }
    });
  }

  // export to XLSX using SheetJS (already included in page)
  function exportToExcel() {
    showConfirm("Export current sheet to Excel?", () => {
      try {
        const table = el('progressTable').cloneNode(true);
        // remove last header cell (Row)
        const theadTR = table.querySelector('thead tr'); if (theadTR && theadTR.lastElementChild) theadTR.removeChild(theadTR.lastElementChild);
        // remove last column in all tbody rows
        qsa('tbody tr', table).forEach(tr => { if (tr.lastElementChild) tr.removeChild(tr.lastElementChild); });
        const wb = XLSX.utils.table_to_book(table, {sheet: "Daily Progress"});
        const date = snapshotDateEl && snapshotDateEl.value || new Date().toISOString().substr(0,10);
        XLSX.writeFile(wb, `DailyProgress_${date}.xlsx`);
      } catch (err) { console.error(err); showToast('Export failed', true); }
    }, 'btn-export');
  }

  // Import from Excel (reads first sheet, groups by date)
  async function importFromExcel(evt) {
    const file = evt.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = e.target.result;
        const wb = XLSX.read(data, {type: 'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });
        if (aoa.length < 2) return showToast('Import failed: empty sheet', true);
        // build date groups
        const dateGroups = {}; let currentDate = null;
        for (let i=1;i<aoa.length;i++){
          const row = aoa[i];
          let dateVal = row[0];
          if (dateVal) {
            if (typeof dateVal === 'number') {
              const excelDate = new Date((dateVal - (25567 + 2)) * 86400 * 1000);
              dateVal = excelDate.toISOString().substr(0,10);
            } else dateVal = String(dateVal).trim();
            currentDate = dateVal;
          }
          if (!currentDate) continue;
          if (!dateGroups[currentDate]) dateGroups[currentDate]=[];
          dateGroups[currentDate].push({
            Date: currentDate,
            Division: row[1]||'',
            SubDivision: row[2]||'',
            Activity: row[3]||'',
            Manpower: row[4]||'',
            Status: row[5]||'',
            Remarks: row[6]||''
          });
        }
        const snapshots = [];
        for (const d in dateGroups) {
          const rows = dateGroups[d];
          let tableHTML = '';
          rows.forEach(r => {
            tableHTML += `<tr>
              <td contenteditable="true">${r.Date}</td>
              <td contenteditable="true">${r.Division}</td>
              <td contenteditable="true">${r.SubDivision}</td>
              <td contenteditable="true">${r.Activity}</td>
              <td contenteditable="true">${r.Manpower}</td>
              <td contenteditable="true">${r.Status}</td>
              <td contenteditable="true">${r.Remarks}</td>
              <td></td>
            </tr>`;
          });
          snapshots.push({ date: d, tableHTML, rowCount: rows.length });
        }
        if (!snapshots.length) return showToast("No valid dates found", true);
        showConfirm(`Found ${snapshots.length} date(s). Import to server?`, async () => {
          try {
            const res = await authFetch(`${API}/daily-progress/batch-import`, { method: 'POST', body: JSON.stringify(snapshots) });
            const data = await res.json().catch(()=>({success:false}));
            if (res.ok) { showToast(data.message || 'Import complete'); loadSavedProgress(); } else { showToast(data.error || 'Import failed', true); }
          } catch (err) { console.error(err); showToast('Import failed', true); }
        }, 'btn-import-label');
      } catch (err) { console.error(err); showToast('Import error', true); }
    };
    reader.onerror = ()=> showToast('File read error', true);
    reader.readAsArrayBuffer(file);
    evt.target.value = null;
  }

  // Merge / unmerge simple implementation
  let selectedCells = [];
  function mergeCells() {
    if (selectedCells.length < 2) return showToast('Select 2+ cells (Shift+Click) to merge', true);
    const rows = selectedCells.map(c => Array.from(sheetTbody.rows).indexOf(c.parentElement));
    const cols = selectedCells.map(c => Array.from(c.parentElement.children).indexOf(c));
    const minR = Math.min(...rows), maxR = Math.max(...rows);
    const minC = Math.min(...cols), maxC = Math.max(...cols);
    const topLeft = sheetTbody.rows[minR].children[minC];
    topLeft.setAttribute('rowspan', maxR - minR + 1);
    topLeft.setAttribute('colspan', maxC - minC + 1);
    selectedCells.forEach(c => { if (c !== topLeft) c.remove(); });
    selectedCells = [];
    updateRowNumbers();
  }
  function unmergeCells() {
    qsa('td[rowspan], td[colspan]', sheetTbody).forEach(td => {
      const tr = td.parentElement;
      const rowIndex = Array.from(sheetTbody.rows).indexOf(tr);
      const colIndex = Array.from(tr.children).indexOf(td);
      const rowspan = parseInt(td.getAttribute('rowspan')||1);
      const colspan = parseInt(td.getAttribute('colspan')||1);
      td.removeAttribute('rowspan'); td.removeAttribute('colspan');
      for (let r = rowIndex; r < rowIndex + rowspan; r++) {
        const targetRow = sheetTbody.rows[r];
        for (let c = colIndex; c < colIndex + colspan; c++) {
          if (r===rowIndex && c===colIndex) continue;
          const newTd = document.createElement('td'); newTd.contentEditable = true; newTd.setAttribute('role','gridcell');
          if (c >= targetRow.children.length) targetRow.appendChild(newTd); else targetRow.insertBefore(newTd, targetRow.children[c]);
        }
      }
    });
    updateRowNumbers();
  }

  /* -------------------- Initial wiring -------------------- */
  function wireUI() {
    // Tabs handled by existing showPanel function in markup; ensure daily panel loads snapshots when activated.
    safeAddEvent(el('trashToggleBtn'), 'click', async () => {
      viewingTrash = !viewingTrash;
      if (viewingTrash) { await loadTrash(); el('trashToggleBtn').textContent='View Active Records'; el('trashToggleBtn').style.backgroundColor='#1D6F42'; el('pdfListTitle').textContent='Trash Bin'; }
      else { await loadRecords(); el('trashToggleBtn').textContent='‚ôªÔ∏è View Trash'; el('trashToggleBtn').style.backgroundColor='#dc3545'; el('pdfListTitle').textContent='All Records'; }
      if (searchEl) searchEl.disabled = viewingTrash;
      if (filterSubEl) filterSubEl.disabled = viewingTrash;
      if (filterTypeEl) filterTypeEl.disabled = viewingTrash;
    });

    safeAddEvent(el('searchInput'), 'input', applyFilters);
    safeAddEvent(el('filterSubDivision'), 'change', applyFilters);
    safeAddEvent(el('filterRecordType'), 'change', applyFilters);
    safeAddEvent(el('pageInfo'), 'click', ()=>{}); // noop keep existing UI stable
    safeAddEvent(el('pdfTableBody') , 'click', (e)=> {
      // make file-row delete button work (delegation)
      const btn = e.target.closest('button');
      if (!btn) return;
      if (btn.textContent.trim() === '‚ùå') btn.closest('tr').remove();
    });
    safeAddEvent(el('addRowBtn'), 'click', ()=> addPDFRow());
    safeAddEvent(el('savePDFBtn'), 'click', saveAllPDFRows);
    safeAddEvent(el('prevPage'), 'click', prevPage);
    safeAddEvent(el('nextPage'), 'click', nextPage);

    // simple prev/next in top controls
    safeAddEvent(document.querySelector('.pagination-btn:nth-of-type(1)'), 'click', prevPage);
    safeAddEvent(document.querySelector('.pagination-btn:nth-of-type(2)'), 'click', nextPage);

    // preview modal close
    safeAddEvent(el('previewModal'), 'click', (e) => { if (e.target === el('previewModal') || e.target.classList.contains('closeBtn')) closePreview(); });
    safeAddEvent(el('snapshotPreviewModal'), 'click', (e) => { if (e.target === el('snapshotPreviewModal') || e.target.classList.contains('closeBtn')) closeSnapshotPreview(); });

    // CL form
    if (el('clForm')) el('clForm').addEventListener('submit', submitCLForm);
    if (el('clActions')) {
    const clEditBtn = el('clActions').querySelector('.top-btn:nth-child(1)');
    const clDeleteBtn = el('clActions').querySelector('.top-btn:nth-child(2)');

    safeAddEvent(clEditBtn, 'click', editSelectedCL);
    safeAddEvent(clDeleteBtn, 'click', deleteSelectedCL);
}


    // saved progress paging controls
    safeAddEvent(document.querySelector('#savedBody ~ div .small:first-child'), 'click', ()=> { if (savedPage>1) { savedPage--; renderSaved(); } }); // optional
    // but more reliable: bind the small buttons by ids if present
    if (el('savedPageInfo')) {
      // prev/next are above saved table ‚Äî find them by the .small buttons around savedSearch
      const smallBtns = document.querySelectorAll('#savedSearch ~ div .small');
      if (smallBtns && smallBtns.length >= 2) {
        smallBtns[0].addEventListener('click', ()=> { if (savedPage>1) { savedPage--; renderSaved(); }});
        smallBtns[1].addEventListener('click', ()=> { if (savedPage < Math.ceil(savedFiltered.length/SAVED_PER_PAGE)) { savedPage++; renderSaved(); }});
      }
    }

    // daily controls
    safeAddEvent(el('addRowBtn'), 'click', ()=> addProgressRow());
    safeAddEvent(el('addRowBtn'), 'click', ()=> addProgressRow()); // keep original Add
    safeAddEvent(el('importFile'), 'change', importFromExcel);
    safeAddEvent(el('autoSaveMsg'), 'click', ()=> {});
    safeAddEvent(el('snapshotDate'), 'change', ()=> { /* nothing special */ });
    // export/merge/unmerge/save/draft buttons
    const btnExport = document.querySelector('.btn-export'); if (btnExport) btnExport.addEventListener('click', exportToExcel);
    const btnMerge = document.querySelector('.btn-merge'); if (btnMerge) btnMerge.addEventListener('click', mergeCells);
    const btnUnmerge = document.querySelector('.btn-unmerge'); if (btnUnmerge) btnUnmerge.addEventListener('click', unmergeCells);
    const btnSaveProgress = document.querySelector('.btn-save'); if (btnSaveProgress) btnSaveProgress.addEventListener('click', saveProgress);
    const btnSaveDraft = document.querySelector('.small[onclick*="saveDraft"]'); if (btnSaveDraft) btnSaveDraft.addEventListener('click', saveDraft);

    // snapshot preview print
    safeAddEvent(el('snapshotPreviewContent') && el('snapshotPreviewContent').querySelector('.print-btn'), 'click', () => {
      const content = el('snapshotFrame') ? el('snapshotFrame').innerHTML : '';
      const w = window.open('', '', 'height=800,width=1000');
      w.document.write('<html><head><title>Print Snapshot</title><style>body{font-family:Arial}table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:8px}</style></head><body>');
      w.document.write(content); w.document.write('</body></html>');
      w.document.close(); w.focus(); setTimeout(()=> { w.print(); w.close(); }, 200);
    });

    // savedSearch input
    if (el('savedSearch')) el('savedSearch').addEventListener('input', (e) => {
      const term = e.target.value.trim().toLowerCase();
      savedPage = 1;
      if (!term) savedFiltered = savedEntries.slice();
      else savedFiltered = savedEntries.filter(item => (item.date||'').toLowerCase().includes(term));
      renderSaved();
    });

    // Collapsible form toggle
    const formToggle = el('formToggle'), formWrapper = el('formWrapper');
    if (formToggle && formWrapper) formToggle.addEventListener('click', () => {
      if (formWrapper.style.display === 'none' || formWrapper.style.display === '') { formWrapper.style.display='block'; formToggle.textContent='Add / Edit Record ‚ûñ'; }
      else { formWrapper.style.display='none'; formToggle.textContent='Add / Edit Record ‚ûï'; }
    });

    // logout/home buttons already wired inline in HTML
  }

  // manual draft save/restore
  function saveDraft() {
    if (!sheetTbody) return;
    localStorage.setItem('dailyProgressDraft', sheetTbody.innerHTML);
    if (autoSaveMsgEl) autoSaveMsgEl.textContent = `Draft saved at ${new Date().toLocaleTimeString()}`;
    showToast('Draft saved locally.');
  }
  function restoreDraft() {
    const draft = localStorage.getItem('dailyProgressDraft');
    if (!draft) return;
    showConfirm('An unsaved draft found. Restore?', () => {
      if (sheetTbody) { sheetTbody.innerHTML = draft; updateRowNumbers(); styleProgressRows(); showToast('Draft restored.'); }
    }, 'restore-btn');
    // If user cancels, remove draft
    const origCancel = el('confirmBtnCancel') && el('confirmBtnCancel').onclick;
    if (el('confirmBtnCancel')) {
      el('confirmBtnCancel').onclick = () => { if (isFn(origCancel)) origCancel(); localStorage.removeItem('dailyProgressDraft'); showToast('Draft discarded.'); };
    }
  }
function showPanel(tab) {
    document.getElementById("pdfPanel").classList.remove("active");
    document.getElementById("dailyPanel").classList.remove("active");
    document.getElementById("clPanel").classList.remove("active");

    document.getElementById("tabPdf").classList.remove("active");
    document.getElementById("tabDaily").classList.remove("active");
    document.getElementById("tabCL").classList.remove("active");

    if (tab === "pdf") {
        document.getElementById("pdfPanel").classList.add("active");
        document.getElementById("tabPdf").classList.add("active");
    } else if (tab === "daily") {
        document.getElementById("dailyPanel").classList.add("active");
        document.getElementById("tabDaily").classList.add("active");
    } else if (tab === "cl") {
        document.getElementById("clPanel").classList.add("active");
        document.getElementById("tabCL").classList.add("active");
    }
}
window.showPanel = showPanel;

  /* -------------------- Startup -------------------- */
  (function start() {
    // wire UI
    wireUI();
    // initial loads (guard the DOM presence)
    loadRecords().catch(()=>{});
    initSheet();
    // set default date
    if (snapshotDateEl && !snapshotDateEl.value) snapshotDateEl.value = new Date().toISOString().slice(0,10);
    loadSavedProgress().catch(()=>{});
    restoreDraft();
    loadCLData().catch(()=>{});
  })();

  // Expose some functions globally for inline onclicks in the markup (if any)
  window.nextPage = nextPage;
  window.prevPage = prevPage;
  window.showConfirm = showConfirm;
  window.previewPDF = previewPDF;
  window.closePreview = closePreview;
  window.openEditRecord = openEditRecord;
  window.downloadPDF = downloadPDF;
  window.addProgressRow = addProgressRow;
  window.insertRowBefore = function(){ if (!lastSelectedRow) sheetTbody.prepend(document.createElement('tr')); else lastSelectedRow.before(document.createElement('tr')); updateRowNumbers(); };
  window.insertRowAfter = function(){ if (!lastSelectedRow) sheetTbody.appendChild(document.createElement('tr')); else lastSelectedRow.after(document.createElement('tr')); updateRowNumbers(); };
  window.saveProgress = saveProgress;
  window.exportToExcel = exportToExcel;
  window.importFromExcel = importFromExcel;
  window.mergeCells = mergeCells;
  window.unmergeCells = unmergeCells;
  window.previewSnapshot = previewSnapshot;
  window.loadSnapshot = loadSnapshot;
  window.deleteSaved = deleteSaved;
  window.closeSnapshotPreview = closeSnapshotPreview;
  window.printSnapshot = () => { const btn = document.querySelector('#snapshotPreviewContent .print-btn'); if (btn) btn.click(); };

  // Keep old simple functions for markup compatibility
  window.goHome = () => window.location.href = 'index.html';
  window.logout = () => { localStorage.removeItem('adminToken'); localStorage.removeItem('isAdmin'); window.location.href = 'login.html'; };

})();
</script>
</body>
</html>

































